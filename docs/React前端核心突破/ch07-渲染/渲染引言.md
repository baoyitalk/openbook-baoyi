æˆ‘æ¥ä»ç¬¬ä¸€æ€§åŸç†æ·±åº¦æ‹†è§£è¿™ä»½ React æ¸²æŸ“ç« èŠ‚çš„å†…å®¹ã€‚

---

## æ ¸å¿ƒé—®é¢˜ï¼šReact å¦‚ä½•é«˜æ•ˆåœ°å°†æ•°æ®å˜æˆ UIï¼Ÿ

æ¸²æŸ“çš„æœ¬è´¨æ˜¯ **æ•°æ® â†’ è™šæ‹ŸDOM â†’ çœŸå®DOM** çš„è½¬æ¢è¿‡ç¨‹ã€‚è¿™ç« è¦è§£å†³çš„é—®é¢˜æ˜¯ï¼šå¦‚ä½•è®©è¿™ä¸ªè¿‡ç¨‹åˆå¿«åˆæµç•…ï¼Ÿ

---

## ä¸€ã€è¿”å›ç©ºå†…å®¹çš„æ–¹æ³•

**ç¬¬ä¸€æ€§åŸç†**ï¼šæœ‰æ—¶ç»„ä»¶ä¸éœ€è¦æ¸²æŸ“ä»»ä½•ä¸œè¥¿ï¼ŒReact éœ€è¦ä¸€ç§æ–¹å¼è¡¨è¾¾"æ— "ã€‚

```jsx
// ä»¥ä¸‹å€¼éƒ½ä¸ä¼šæ¸²æŸ“ä»»ä½• DOM
function EmptyComponent({ show }) {
  if (!show) return null;        // æœ€å¸¸ç”¨
  if (!show) return false;       // ä¹Ÿå¯ä»¥
  if (!show) return undefined;   // ä¹Ÿå¯ä»¥
  if (!show) return <></>;       // Fragment ç©ºæ ‡ç­¾
}

// å®é™…åº”ç”¨ï¼šæ¡ä»¶æ¸²æŸ“
function Notification({ message }) {
  if (!message) return null;
  return <div className="toast">{message}</div>;
}
```

---

## äºŒã€ä¼˜åŒ–ä¸å¿…è¦çš„æ¸²æŸ“ï¼ˆâ­â­â­â­â­ æœ€é«˜é¢‘ï¼‰

**ç¬¬ä¸€æ€§åŸç†**ï¼šæ¸²æŸ“æœ‰æˆæœ¬ï¼Œå¦‚æœè¾“å‡ºä¸å˜ï¼Œå°±ä¸åº”è¯¥é‡æ–°è®¡ç®—ã€‚

### æ¸²æŸ“è§¦å‘çš„æ ¹æœ¬åŸå› 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç»„ä»¶ä¸ºä»€ä¹ˆä¼šé‡æ–°æ¸²æŸ“ï¼Ÿ                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. è‡ªèº« state å˜åŒ–                                      â”‚
â”‚  2. çˆ¶ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼ˆå³ä½¿ props æ²¡å˜ï¼ï¼‰                    â”‚
â”‚  3. Context value å˜åŒ–                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¼˜åŒ–ç­–ç•¥å…¨æ™¯å›¾

```
                        æ¸²æŸ“ä¼˜åŒ–ç­–ç•¥
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                   â–¼                   â–¼
   å‡å°‘æ¸²æŸ“æ¬¡æ•°         å‡å°‘æ¸²æŸ“èŒƒå›´          å‡å°‘æ¸²æŸ“æˆæœ¬
        â”‚                   â”‚                   â”‚
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
   â”‚         â”‚         â”‚         â”‚         â”‚         â”‚
 memo    useMemo     æ‹†åˆ†ç»„ä»¶   æ‡’åŠ è½½     è™šæ‹Ÿåˆ—è¡¨  é˜²æŠ–èŠ‚æµ
useCallback  çŠ¶æ€ä¸‹æ²‰   keyä¼˜åŒ–
```

### ç­–ç•¥ä¸€ï¼šmemo - é˜»æ­¢æ— æ„ä¹‰çš„é‡æ¸²æŸ“

```jsx
// âŒ é—®é¢˜ï¼šçˆ¶ç»„ä»¶æ¯æ¬¡æ¸²æŸ“ï¼ŒChild éƒ½ä¼šé‡æ¸²æŸ“
function Parent() {
  const [count, setCount] = useState(0);
  return (
    <div>
      <button onClick={() => setCount(c => c + 1)}>+</button>
      <Child name="å›ºå®šå€¼" />  {/* æ¯æ¬¡éƒ½é‡æ¸²æŸ“ï¼ */}
    </div>
  );
}

// âœ… è§£å†³ï¼šç”¨ memo åŒ…è£¹
const Child = memo(function Child({ name }) {
  console.log('Child æ¸²æŸ“äº†');
  return <div>{name}</div>;
});

// è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°ï¼ˆæ·±åº¦æ§åˆ¶ï¼‰
const Child = memo(
  function Child({ user }) {
    return <div>{user.name}</div>;
  },
  (prevProps, nextProps) => prevProps.user.id === nextProps.user.id
);
```

### ç­–ç•¥äºŒï¼šuseMemo & useCallback - ç¨³å®šå¼•ç”¨

```jsx
function SearchResults({ query, data }) {
  // âœ… useMemoï¼šç¼“å­˜è®¡ç®—ç»“æœ
  const filtered = useMemo(() => {
    console.log('æ‰§è¡Œè¿‡æ»¤è®¡ç®—');
    return data.filter(item => item.name.includes(query));
  }, [data, query]);  // åªæœ‰ä¾èµ–å˜åŒ–æ‰é‡æ–°è®¡ç®—

  // âœ… useCallbackï¼šç¼“å­˜å‡½æ•°å¼•ç”¨
  const handleClick = useCallback((id) => {
    console.log('ç‚¹å‡»äº†', id);
  }, []);  // ç©ºä¾èµ– = æ°¸è¿œåŒä¸€ä¸ªå‡½æ•°

  return (
    <ul>
      {filtered.map(item => (
        <MemoizedItem 
          key={item.id} 
          item={item} 
          onClick={handleClick}  // ç¨³å®šå¼•ç”¨ï¼Œä¸ä¼šå¯¼è‡´ Item é‡æ¸²æŸ“
        />
      ))}
    </ul>
  );
}
```

### ç­–ç•¥ä¸‰ï¼šçŠ¶æ€ä¸‹æ²‰ & ç»„ä»¶æ‹†åˆ†

```jsx
// âŒ é—®é¢˜ï¼šè¾“å…¥æ¡†å˜åŒ–å¯¼è‡´æ•´ä¸ªå¤§ç»„ä»¶é‡æ¸²æŸ“
function BigComponent() {
  const [text, setText] = useState('');
  return (
    <div>
      <input value={text} onChange={e => setText(e.target.value)} />
      <ExpensiveChart />  {/* æ¯æ¬¡è¾“å…¥éƒ½é‡æ¸²æŸ“ï¼ */}
      <ExpensiveTable />
    </div>
  );
}

// âœ… è§£å†³ï¼šå°†çŠ¶æ€ä¸‹æ²‰åˆ°éœ€è¦å®ƒçš„ç»„ä»¶
function BigComponent() {
  return (
    <div>
      <SearchInput />      {/* çŠ¶æ€å°è£…åœ¨å†…éƒ¨ */}
      <ExpensiveChart />   {/* ä¸å†å—å½±å“ */}
      <ExpensiveTable />
    </div>
  );
}

function SearchInput() {
  const [text, setText] = useState('');  // çŠ¶æ€ä¸‹æ²‰
  return <input value={text} onChange={e => setText(e.target.value)} />;
}
```

### ç­–ç•¥å››ï¼škey çš„æ­£ç¡®ä½¿ç”¨

```jsx
// âŒ é”™è¯¯ï¼šç”¨ index åš key
{items.map((item, index) => (
  <Item key={index} data={item} />  // åˆ—è¡¨å˜åŒ–æ—¶ä¼šé”™è¯¯å¤ç”¨
))}

// âœ… æ­£ç¡®ï¼šç”¨å”¯ä¸€æ ‡è¯†
{items.map(item => (
  <Item key={item.id} data={item} />
))}

// ğŸ”¥ æŠ€å·§ï¼šç”¨ key å¼ºåˆ¶é‡ç½®ç»„ä»¶çŠ¶æ€
<UserProfile key={userId} userId={userId} />
// userId å˜åŒ–æ—¶ï¼Œç»„ä»¶å®Œå…¨é‡å»ºè€Œä¸æ˜¯æ›´æ–°
```

### ç­–ç•¥äº”ï¼šè™šæ‹Ÿåˆ—è¡¨ - åªæ¸²æŸ“å¯è§åŒºåŸŸ

```jsx
import { FixedSizeList } from 'react-window';

function VirtualList({ items }) {
  return (
    <FixedSizeList
      height={400}
      width={300}
      itemCount={items.length}
      itemSize={50}  // æ¯é¡¹é«˜åº¦
    >
      {({ index, style }) => (
        <div style={style}>
          {items[index].name}
        </div>
      )}
    </FixedSizeList>
  );
}
// 10ä¸‡æ¡æ•°æ®ä¹Ÿåªæ¸²æŸ“å¯è§çš„å‡ åä¸ª DOM èŠ‚ç‚¹
```

### ç­–ç•¥å…­ï¼šé˜²æŠ–èŠ‚æµ

```jsx
function SearchInput({ onSearch }) {
  const [value, setValue] = useState('');
  
  // é˜²æŠ–ï¼šåœæ­¢è¾“å…¥ 300ms åæ‰æœç´¢
  const debouncedSearch = useMemo(
    () => debounce((v) => onSearch(v), 300),
    [onSearch]
  );
  
  useEffect(() => {
    debouncedSearch(value);
    return () => debouncedSearch.cancel();
  }, [value, debouncedSearch]);
  
  return <input value={value} onChange={e => setValue(e.target.value)} />;
}
```

---

## ä¸‰ã€æ¸²æŸ“ HTML å­—ç¬¦ä¸²

**ç¬¬ä¸€æ€§åŸç†**ï¼šReact é»˜è®¤è½¬ä¹‰æ‰€æœ‰å†…å®¹é˜²æ­¢ XSSï¼Œä½†æœ‰æ—¶ç¡®å®éœ€è¦æ¸²æŸ“ HTMLã€‚

```jsx
// dangerouslySetInnerHTML - åå­—å°±æ˜¯è­¦å‘Š
function RichContent({ html }) {
  return (
    <div 
      dangerouslySetInnerHTML={{ __html: html }} 
    />
  );
}

// âš ï¸ é£é™©ï¼šXSS æ”»å‡»
const userInput = '<img src="x" onerror="alert(document.cookie)">';
<div dangerouslySetInnerHTML={{ __html: userInput }} />  // å±é™©ï¼

// âœ… å®‰å…¨åšæ³•ï¼šä½¿ç”¨ DOMPurify æ¶ˆæ¯’
import DOMPurify from 'dompurify';

function SafeHTML({ html }) {
  const clean = DOMPurify.sanitize(html);
  return <div dangerouslySetInnerHTML={{ __html: clean }} />;
}
```

---

## å››ã€React Fiber æ¶æ„ï¼ˆâ­â­â­ è¿›é˜¶å¿…è€ƒï¼‰

### ä¸ºä»€ä¹ˆéœ€è¦ Fiberï¼Ÿ

**ç¬¬ä¸€æ€§åŸç†**ï¼šæµè§ˆå™¨æ˜¯å•çº¿ç¨‹çš„ï¼Œé•¿ä»»åŠ¡ä¼šé˜»å¡ç”¨æˆ·äº¤äº’ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ—§æ¶æ„é—®é¢˜ (Stack Reconciler)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ç”¨æˆ·ç‚¹å‡»    å¼€å§‹æ¸²æŸ“â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ¸²æŸ“å®Œæˆ       â”‚
â”‚      â”‚            â”‚                                â”‚            â”‚
â”‚      â–¼            â”‚â†â”€â”€â”€â”€ 100ms ä¸èƒ½ä¸­æ–­ â”€â”€â”€â”€â†’â”‚            â”‚
â”‚   æƒ³è¦å“åº”        â”‚                                â”‚            â”‚
â”‚      â”‚            â”‚                                â”‚            â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€ è¢«é˜»å¡ï¼Œç”¨æˆ·æ„Ÿè§‰å¡é¡¿ â”€â”€â”˜            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ–°æ¶æ„ (Fiber Reconciler)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ç”¨æˆ·ç‚¹å‡»    æ¸²æŸ“â†’æš‚åœâ†’å“åº”ç”¨æˆ·â†’ç»§ç»­æ¸²æŸ“â†’æš‚åœâ†’ç»§ç»­â†’å®Œæˆ         â”‚
â”‚      â”‚         â”‚      â”‚        â”‚                               â”‚
â”‚      â–¼         â–¼      â–¼        â–¼                               â”‚
â”‚   æƒ³è¦å“åº”   5mså·¥ä½œ  ç«‹å³å“åº”  ç»§ç»­å·¥ä½œ                          â”‚
â”‚      â”‚              â†‘                                          â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ æµç•…ï¼                                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Fiber æ˜¯ä»€ä¹ˆï¼Ÿ

```
Fiber = è™šæ‹Ÿçš„å †æ ˆå¸§ = å¯æš‚åœã€å¯æ¢å¤çš„å·¥ä½œå•å…ƒ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Fiber èŠ‚ç‚¹ç»“æ„              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  type        â”‚ ç»„ä»¶ç±»å‹ (å‡½æ•°/ç±»/æ ‡ç­¾)   â”‚
â”‚  key         â”‚ ç”¨äº diff çš„å”¯ä¸€æ ‡è¯†      â”‚
â”‚  child       â”‚ ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹              â”‚
â”‚  sibling     â”‚ ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹            â”‚
â”‚  return      â”‚ çˆ¶èŠ‚ç‚¹                    â”‚
â”‚  pendingPropsâ”‚ æ–°çš„ props               â”‚
â”‚  memoizedPropsâ”‚ ä¸Šæ¬¡çš„ props            â”‚
â”‚  memoizedStateâ”‚ ä¸Šæ¬¡çš„ state            â”‚
â”‚  alternate   â”‚ å¦ä¸€æ£µæ ‘çš„å¯¹åº”èŠ‚ç‚¹        â”‚
â”‚  effectTag   â”‚ å‰¯ä½œç”¨æ ‡è®° (å¢/åˆ /æ”¹)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Fiber æ ‘çš„éå†æ–¹å¼

```jsx
// ç»„ä»¶ç»“æ„
<App>
  <Header />
  <Main>
    <Article />
    <Sidebar />
  </Main>
</App>

// Fiber é“¾è¡¨ç»“æ„ (æ·±åº¦ä¼˜å…ˆ)
App
 â”‚
 â”œâ”€childâ†’ Header
 â”‚           â”‚
 â”‚       siblingâ†’ Main
 â”‚                  â”‚
 â”‚              childâ†’ Article
 â”‚                        â”‚
 â”‚                    siblingâ†’ Sidebar
 â”‚
 â””â”€returnâ”€â”
          â”‚
     æ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰ return æŒ‡å‘çˆ¶èŠ‚ç‚¹
```

### ä¸¤é˜¶æ®µæ¸²æŸ“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Render/Reconciliation é˜¶æ®µ                 â”‚
â”‚                        (å¯ä¸­æ–­ âœ“)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚work â”‚â”€â”€â”€â†’â”‚work â”‚â”€â”€â”€â†’â”‚æš‚åœ â”‚â”€â”€â”€â†’â”‚work â”‚â”€â”€â†’ æ”¶é›†å‰¯ä½œç”¨     â”‚
â”‚  â”‚unit1â”‚    â”‚unit2â”‚    â”‚è®©å‡º â”‚    â”‚unit3â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                           â”‚                                  â”‚
â”‚                    å¤„ç†ç”¨æˆ·è¾“å…¥                               â”‚
â”‚                                                              â”‚
â”‚  ç”Ÿå‘½å‘¨æœŸï¼šconstructor, getDerivedStateFromProps,            â”‚
â”‚           shouldComponentUpdate, render                      â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Commit é˜¶æ®µ                              â”‚
â”‚                    (ä¸å¯ä¸­æ–­ âœ—)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  ä¸€æ¬¡æ€§æ‰§è¡Œæ‰€æœ‰ DOM æ“ä½œå’Œå‰¯ä½œç”¨              â”‚              â”‚
â”‚  â”‚  â€¢ æ›´æ–° DOM                                 â”‚              â”‚
â”‚  â”‚  â€¢ è°ƒç”¨ ref å›è°ƒ                            â”‚              â”‚
â”‚  â”‚  â€¢ componentDidMount / componentDidUpdate  â”‚              â”‚
â”‚  â”‚  â€¢ useLayoutEffect                         â”‚              â”‚
â”‚  â”‚  â€¢ useEffect (å¼‚æ­¥è°ƒåº¦)                     â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ—¶é—´åˆ‡ç‰‡åŸç†

```jsx
// ç®€åŒ–ç‰ˆè°ƒåº¦åŸç†
function workLoop(deadline) {
  let shouldYield = false;
  
  while (nextUnitOfWork && !shouldYield) {
    // æ‰§è¡Œä¸€ä¸ªå·¥ä½œå•å…ƒ
    nextUnitOfWork = performUnitOfWork(nextUnitOfWork);
    // æ£€æŸ¥æ˜¯å¦è¯¥è®©å‡ºæ§åˆ¶æƒ
    shouldYield = deadline.timeRemaining() < 1;
  }
  
  if (nextUnitOfWork) {
    // è¿˜æœ‰å·¥ä½œï¼Œè¯·æ±‚ä¸‹æ¬¡ç©ºé—²æ—¶ç»§ç»­
    requestIdleCallback(workLoop);
  } else {
    // å·¥ä½œå®Œæˆï¼Œè¿›å…¥ commit é˜¶æ®µ
    commitRoot();
  }
}

requestIdleCallback(workLoop);
```

### ä¼˜å…ˆçº§è°ƒåº¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ä»»åŠ¡ä¼˜å…ˆçº§                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Immediate     â”‚  åŒæ­¥ï¼Œå¿…é¡»ç«‹å³æ‰§è¡Œ                â”‚
â”‚  UserBlocking  â”‚  ç”¨æˆ·äº¤äº’ï¼ˆç‚¹å‡»ã€è¾“å…¥ï¼‰            â”‚
â”‚  Normal        â”‚  æ™®é€šæ›´æ–°ï¼ˆæ•°æ®è¯·æ±‚åæ›´æ–°ï¼‰        â”‚
â”‚  Low           â”‚  ä½ä¼˜å…ˆçº§ï¼ˆåˆ†ææ•°æ®ä¸ŠæŠ¥ï¼‰          â”‚
â”‚  Idle          â”‚  ç©ºé—²æ—¶æ‰§è¡Œï¼ˆé¢„åŠ è½½ï¼‰              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// å®é™…åº”ç”¨ï¼šuseTransition
function Search() {
  const [query, setQuery] = useState('');
  const [results, setResults] = useState([]);
  const [isPending, startTransition] = useTransition();
  
  function handleChange(e) {
    setQuery(e.target.value);  // é«˜ä¼˜å…ˆçº§ï¼šç«‹å³æ›´æ–°è¾“å…¥æ¡†
    
    startTransition(() => {
      setResults(filterData(e.target.value));  // ä½ä¼˜å…ˆçº§ï¼šå¯ä¸­æ–­
    });
  }
  
  return (
    <div>
      <input value={query} onChange={handleChange} />
      {isPending ? <Spinner /> : <Results data={results} />}
    </div>
  );
}
```

---

## äº”ã€é¢è¯•é«˜é¢‘ä»£ç é¢˜

### å®ç° memo çš„ç®€åŒ–ç‰ˆ

```jsx
function memo(Component, compare = shallowEqual) {
  let prevProps = null;
  let prevResult = null;
  
  return function MemoizedComponent(props) {
    if (prevProps && compare(prevProps, props)) {
      return prevResult;  // props æ²¡å˜ï¼Œè¿”å›ç¼“å­˜ç»“æœ
    }
    prevProps = props;
    prevResult = <Component {...props} />;
    return prevResult;
  };
}

function shallowEqual(a, b) {
  if (a === b) return true;
  const keysA = Object.keys(a);
  const keysB = Object.keys(b);
  if (keysA.length !== keysB.length) return false;
  return keysA.every(key => a[key] === b[key]);
}
```

### å®ç°ç®€æ˜“ useCallback / useMemo

```jsx
// useCallback æœ¬è´¨æ˜¯ç‰¹æ®Šçš„ useMemo
function useCallback(callback, deps) {
  return useMemo(() => callback, deps);
}

// useMemo ç®€åŒ–å®ç°
let memoizedState = [];
let cursor = 0;

function useMemo(factory, deps) {
  const prevState = memoizedState[cursor];
  
  // æ£€æŸ¥ä¾èµ–æ˜¯å¦å˜åŒ–
  const hasChanged = prevState
    ? !deps.every((dep, i) => dep === prevState.deps[i])
    : true;
  
  if (hasChanged) {
    const value = factory();
    memoizedState[cursor] = { value, deps };
    cursor++;
    return value;
  }
  
  cursor++;
  return prevState.value;
}
```

---

## é¢è¯•ç­”é¢˜æ¨¡æ¿

| é—®é¢˜ | å…³é”®ç‚¹ |
|------|--------|
| å¦‚ä½•è¿”å›ç©º | `null`ã€`false`ã€`undefined`ã€`</>` |
| ä¼˜åŒ–æ¸²æŸ“æ–¹æ³• | memoã€useMemoã€useCallbackã€çŠ¶æ€ä¸‹æ²‰ã€keyã€è™šæ‹Ÿåˆ—è¡¨ |
| memo vs useMemo | memo åŒ…ç»„ä»¶ï¼ŒuseMemo ç¼“å­˜å€¼ |
| useCallback ä½œç”¨ | ç¨³å®šå‡½æ•°å¼•ç”¨ï¼Œé…åˆ memo ä½¿ç”¨ |
| dangerouslySetInnerHTML é£é™© | XSS æ”»å‡»ï¼Œéœ€é…åˆ DOMPurify |
| ä¸ºä»€ä¹ˆéœ€è¦ Fiber | æ—§æ¶æ„åŒæ­¥æ¸²æŸ“é˜»å¡ UIï¼ŒFiber å¯ä¸­æ–­ |
| Fiber æ˜¯ä»€ä¹ˆ | è™šæ‹Ÿå †æ ˆå¸§ï¼Œå¯æš‚åœæ¢å¤çš„å·¥ä½œå•å…ƒ |
| ä¸¤ä¸ªé˜¶æ®µ | Render(å¯ä¸­æ–­) + Commit(ä¸å¯ä¸­æ–­) |

**ä¸€å¥è¯æ€»ç»“**ï¼šReact æ¸²æŸ“ä¼˜åŒ–çš„æ ¸å¿ƒæ˜¯"å‡å°‘ä¸å¿…è¦çš„å·¥ä½œ"ï¼ŒFiber åˆ™æ˜¯è®©"å¿…è¦çš„å·¥ä½œ"ä¹Ÿèƒ½ä¼˜é›…åœ°æ‰§è¡Œè€Œä¸é˜»å¡ç”¨æˆ·ã€‚