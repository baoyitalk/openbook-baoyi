# React é”™è¯¯è¾¹ç•Œ - ç¬¬ä¸€æ€§åŸç†æ·±åº¦æ‹†è§£

## ä¸€ã€ç¬¬ä¸€æ€§åŸç†ï¼šä¸ºä»€ä¹ˆéœ€è¦é”™è¯¯è¾¹ç•Œï¼Ÿ

### æœ¬è´¨æ€è€ƒ

JavaScript ä¸­ï¼Œä¸€ä¸ªæœªæ•è·çš„é”™è¯¯ä¼šå¯¼è‡´æ•´ä¸ªåº”ç”¨å´©æºƒã€‚åœ¨ React ä¸­ï¼Œ**éƒ¨åˆ† UI çš„é”™è¯¯ä¸åº”è¯¥å¯¼è‡´æ•´ä¸ªåº”ç”¨å´©æºƒ**ã€‚

React 16 ä¹‹å‰ï¼šç»„ä»¶é”™è¯¯ä¼šå¯¼è‡´æ•´ä¸ªç»„ä»¶æ ‘å¤„äºæŸåçŠ¶æ€ï¼Œä½†ä»ç„¶æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šã€‚
React 16 ä¹‹åï¼šæœªæ•è·é”™è¯¯ä¼šå¯¼è‡´**æ•´ä¸ªç»„ä»¶æ ‘è¢«å¸è½½ï¼Œæ˜¾ç¤ºç™½å±**ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸ºä»€ä¹ˆé€‰æ‹©ç™½å±ï¼Ÿ                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  React è®¤ä¸ºï¼šæŠŠé”™è¯¯çš„ UI ç•™åœ¨é‚£æ¯”å®Œå…¨ç§»é™¤å®ƒæ›´ç³Ÿç³•              â”‚
â”‚                                                             â”‚
â”‚  ä¾‹å¦‚ï¼š                                                      â”‚
â”‚  â€¢ å³æ—¶é€šä¿¡åº”ç”¨ä¸­å±•ç¤ºé”™è¯¯çš„æ¶ˆæ¯                               â”‚
â”‚  â€¢ æ”¯ä»˜åº”ç”¨ä¸­å±•ç¤ºé”™è¯¯çš„é‡‘é¢                                   â”‚
â”‚  â†’ è¿™äº›éƒ½æ¯”ä¸å‘ˆç°ä»»ä½•å†…å®¹æ›´ç³Ÿç³•                               â”‚
â”‚                                                             â”‚
â”‚  ç™½å±æœ‰åŠ©äºå¼€å‘è€…å‘ç°å·²å­˜åœ¨ä½†æœªæ³¨æ„åˆ°çš„å´©æºƒ                    â”‚
â”‚  ä¿ƒä½¿å¼€å‘è€…æ‰‹åŠ¨å¢åŠ é”™è¯¯è¾¹ç•Œï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ                â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é”™è¯¯è¾¹ç•Œçš„å®šä½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é”™è¯¯è¾¹ç•Œçš„ä½œç”¨                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚    é”™è¯¯è¾¹ç•Œ = React ç»„ä»¶çš„ try-catch                         â”‚
â”‚                                                             â”‚
â”‚    åŠŸèƒ½ï¼š                                                    â”‚
â”‚    1. æ•è·å­ç»„ä»¶æ ‘ä¸­çš„ JavaScript é”™è¯¯                       â”‚
â”‚    2. æ‰“å°é”™è¯¯ä¿¡æ¯                                           â”‚
â”‚    3. å±•ç¤ºé™çº§ UIï¼ˆFallback UIï¼‰                             â”‚
â”‚    4. ä¸æ¸²æŸ“å‘ç”Ÿå´©æºƒçš„å­ç»„ä»¶æ ‘                               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€ä»€ä¹ˆæ˜¯é”™è¯¯è¾¹ç•Œï¼Ÿ

### å®šä¹‰

é”™è¯¯è¾¹ç•Œæ˜¯ä¸€ç§ **React ç»„ä»¶**ï¼Œå®ƒå¯ä»¥æ•è·å‘ç”Ÿåœ¨å…¶å­ç»„ä»¶æ ‘ä»»ä½•ä½ç½®çš„ JavaScript é”™è¯¯ï¼Œå¹¶æ‰“å°è¿™äº›é”™è¯¯ï¼ŒåŒæ—¶å±•ç¤ºé™çº§ UIã€‚

### å¦‚ä½•æ„å»ºé”™è¯¯è¾¹ç•Œç»„ä»¶ï¼Ÿ

ä¸€ä¸ª class ç»„ä»¶å®šä¹‰äº†ä»¥ä¸‹ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­çš„**ä»»æ„ä¸€ä¸ªï¼ˆæˆ–ä¸¤ä¸ªï¼‰**ï¼Œå°±å˜æˆäº†é”™è¯¯è¾¹ç•Œï¼š

| ç”Ÿå‘½å‘¨æœŸ | ä½œç”¨ | é˜¶æ®µ | å‰¯ä½œç”¨ |
|---------|------|------|--------|
| `static getDerivedStateFromError(error)` | æ¸²æŸ“å¤‡ç”¨ UI | Render é˜¶æ®µ | âŒ ä¸å…è®¸ |
| `componentDidCatch(error, info)` | æ‰“å°/ä¸ŠæŠ¥é”™è¯¯ | Commit é˜¶æ®µ | âœ… å…è®¸ |

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é”™è¯¯æ•è·æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   å­ç»„ä»¶æŠ›å‡ºé”™è¯¯                                             â”‚
â”‚        â†“                                                    â”‚
â”‚   getDerivedStateFromError(error)  â† Render é˜¶æ®µ            â”‚
â”‚   è¿”å›æ–° stateï¼Œè§¦å‘é‡æ–°æ¸²æŸ“                                 â”‚
â”‚        â†“                                                    â”‚
â”‚   render() æ¸²æŸ“é™çº§ UI                                       â”‚
â”‚        â†“                                                    â”‚
â”‚   componentDidCatch(error, info)   â† Commit é˜¶æ®µ            â”‚
â”‚   æ‰“å°é”™è¯¯ã€ä¸ŠæŠ¥é”™è¯¯æ—¥å¿—æœåŠ¡                                  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€é”™è¯¯è¾¹ç•Œèƒ½æ•è· vs ä¸èƒ½æ•è·çš„é”™è¯¯

### âœ… èƒ½æ•è·çš„é”™è¯¯

é”™è¯¯è¾¹ç•Œå¯ä»¥æ•è·**å­ç»„ä»¶**åœ¨ä»¥ä¸‹åœºæ™¯ä¸­çš„é”™è¯¯ï¼š

| åœºæ™¯ | ç¤ºä¾‹ |
|-----|------|
| **æ¸²æŸ“æœŸé—´** | render() æ–¹æ³•ä¸­çš„é”™è¯¯ |
| **ç”Ÿå‘½å‘¨æœŸæ–¹æ³•** | componentDidMountã€componentDidUpdate ç­‰ |
| **æ„é€ å‡½æ•°** | constructor() ä¸­çš„é”™è¯¯ |

### âŒ ä¸èƒ½æ•è·çš„é”™è¯¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              é”™è¯¯è¾¹ç•Œä¸èƒ½æ•è·çš„åœºæ™¯                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. äº‹ä»¶å¤„ç†å‡½æ•°                                             â”‚
â”‚     â†’ ä¸åœ¨æ¸²æŸ“æœŸé—´è§¦å‘ï¼ŒReact ä»èƒ½çŸ¥é“æ˜¾ç¤ºä»€ä¹ˆ                â”‚
â”‚                                                             â”‚
â”‚  2. å¼‚æ­¥ä»£ç                                                  â”‚
â”‚     â€¢ setTimeout / setInterval                              â”‚
â”‚     â€¢ requestAnimationFrame / requestIdleCallback           â”‚
â”‚     â€¢ Promise                                               â”‚
â”‚     â€¢ RxJS Subscribe å›è°ƒ                                   â”‚
â”‚     â€¢ Observer (IntersectionObserver / MutationObserver)    â”‚
â”‚                                                             â”‚
â”‚  3. æœåŠ¡ç«¯æ¸²æŸ“ (SSR)                                         â”‚
â”‚                                                             â”‚
â”‚  4. é”™è¯¯è¾¹ç•Œè‡ªèº«æŠ›å‡ºçš„é”™è¯¯                                    â”‚
â”‚     â†’ åªèƒ½æ•è·å­ç»„ä»¶çš„é”™è¯¯ï¼Œä¸èƒ½æ•è·è‡ªå·±çš„                    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸ºä»€ä¹ˆäº‹ä»¶å¤„ç†å‡½æ•°çš„é”™è¯¯ä¸èƒ½è¢«æ•è·ï¼Ÿ

```javascript
// äº‹ä»¶å¤„ç†ä¸åœ¨æ¸²æŸ“æœŸé—´è§¦å‘
// å³ä½¿äº‹ä»¶å¤„ç†å‡½æ•°æŠ›å‡ºå¼‚å¸¸ï¼ŒReact ä»ç„¶èƒ½å¤ŸçŸ¥é“éœ€è¦åœ¨å±å¹•ä¸Šæ˜¾ç¤ºä»€ä¹ˆ
function Button() {
  const handleClick = () => {
    throw new Error('Click error');  // âŒ é”™è¯¯è¾¹ç•Œæ•è·ä¸åˆ°
  };
  
  return <button onClick={handleClick}>Click</button>;
  // æŒ‰é’®ä»ç„¶ä¼šæ­£å¸¸æ¸²æŸ“ï¼Œé”™è¯¯åªåœ¨ç‚¹å‡»æ—¶å‘ç”Ÿ
}
```

---

## å››ã€é”™è¯¯è¾¹ç•Œåº”è¯¥æ”¾ç½®åœ¨ä»€ä¹ˆä½ç½®ï¼Ÿ

### æ”¾ç½®ç­–ç•¥

é”™è¯¯è¾¹ç•Œçš„ä½ç½®ç”±å¼€å‘è€…å†³å®šï¼Œå–å†³äºä½ å¸Œæœ›é”™è¯¯å½±å“çš„èŒƒå›´ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é”™è¯¯è¾¹ç•Œæ”¾ç½®ç­–ç•¥                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ç­–ç•¥1ï¼šæœ€é¡¶å±‚è·¯ç”±ç»„ä»¶                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ <ErrorBoundary>                     â”‚                   â”‚
â”‚  â”‚   <App />  â† ä»»ä½•ç»„ä»¶æŠ¥é”™éƒ½å±•ç¤ºé”™è¯¯é¡µ â”‚                   â”‚
â”‚  â”‚ </ErrorBoundary>                    â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚  é€‚ç”¨ï¼šç®€å•åº”ç”¨ã€å¸Œæœ›ç»Ÿä¸€å±•ç¤ºé”™è¯¯ä¿¡æ¯                         â”‚
â”‚                                                             â”‚
â”‚  ç­–ç•¥2ï¼šåŒ…è£¹å•ç‹¬çš„ç»„ä»¶/åŠŸèƒ½æ¨¡å—                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ <Layout>                            â”‚                   â”‚
â”‚  â”‚   <Header />                        â”‚                   â”‚
â”‚  â”‚   <ErrorBoundary>                   â”‚                   â”‚
â”‚  â”‚     <Sidebar /> â† ä¾§è¾¹æ å´©æºƒä¸å½±å“  â”‚                   â”‚
â”‚  â”‚   </ErrorBoundary>      å…¶ä»–éƒ¨åˆ†    â”‚                   â”‚
â”‚  â”‚   <ErrorBoundary>                   â”‚                   â”‚
â”‚  â”‚     <Content /> â† å†…å®¹åŒºå´©æºƒä¸å½±å“  â”‚                   â”‚
â”‚  â”‚   </ErrorBoundary>      å…¶ä»–éƒ¨åˆ†    â”‚                   â”‚
â”‚  â”‚ </Layout>                           â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚  é€‚ç”¨ï¼šå¤æ‚åº”ç”¨ã€å¸Œæœ›å±€éƒ¨é™çº§ä¸å½±å“æ•´ä½“                       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€é”™è¯¯æ•è·çš„ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸ

### static getDerivedStateFromError(error)

```javascript
static getDerivedStateFromError(error) {
  // åœ¨åä»£ç»„ä»¶æŠ›å‡ºé”™è¯¯åè¢«è°ƒç”¨
  // å°†æŠ›å‡ºçš„é”™è¯¯ä½œä¸ºå‚æ•°
  // è¿”å›ä¸€ä¸ªå€¼ä»¥æ›´æ–° state
  // åœ¨ Render é˜¶æ®µè°ƒç”¨ï¼Œå› æ­¤ä¸å…è®¸å‡ºç°å‰¯ä½œç”¨
  return { hasError: true };
}
```

### componentDidCatch(error, info)

```javascript
componentDidCatch(error, info) {
  // åœ¨åä»£ç»„ä»¶æŠ›å‡ºé”™è¯¯åè¢«è°ƒç”¨
  // error: æŠ›å‡ºçš„é”™è¯¯
  // info: åŒ…å« componentStack çš„å¯¹è±¡ï¼Œè®°å½•å¼•å‘é”™è¯¯çš„ç»„ä»¶æ ˆä¿¡æ¯
  // åœ¨ Commit é˜¶æ®µè°ƒç”¨ï¼Œå…è®¸æ‰§è¡Œå‰¯ä½œç”¨ï¼ˆå¦‚ä¸ŠæŠ¥é”™è¯¯æ—¥å¿—ï¼‰
  
  console.error('Error:', error);
  console.error('Component Stack:', info.componentStack);
  
  // ä¸ŠæŠ¥é”™è¯¯åˆ°æœåŠ¡
  logErrorToService(error, info);
}
```

### ä¸¤è€…çš„åŒºåˆ«

| ç‰¹æ€§ | getDerivedStateFromError | componentDidCatch |
|-----|-------------------------|-------------------|
| ç±»å‹ | é™æ€æ–¹æ³• | å®ä¾‹æ–¹æ³• |
| è°ƒç”¨é˜¶æ®µ | Render é˜¶æ®µ | Commit é˜¶æ®µ |
| å‰¯ä½œç”¨ | âŒ ä¸å…è®¸ | âœ… å…è®¸ |
| ä¸»è¦ç”¨é€” | æ›´æ–° stateï¼Œæ¸²æŸ“é™çº§ UI | æ‰“å°é”™è¯¯ã€ä¸ŠæŠ¥æ—¥å¿— |
| å‚æ•° | (error) | (error, info) |

---

## å…­ã€React å¦‚ä½•å¤„ç†æœªæ•è·é”™è¯¯ï¼Ÿ

### è¡Œä¸º

è‡ª React 16 èµ·ï¼Œä»»ä½•æœªè¢«é”™è¯¯è¾¹ç•Œæ•è·çš„é”™è¯¯å°†ä¼šå¯¼è‡´ï¼š
1. **æ•´ä¸ª React ç»„ä»¶æ ‘è¢«å¸è½½**
2. **é¡µé¢æ˜¾ç¤ºç™½å±**
3. **æ§åˆ¶å°è¾“å‡ºæŠ¥é”™ä¿¡æ¯**

### ä¸ºä»€ä¹ˆè¿™æ ·å¤„ç†ï¼Ÿ

React è®¤ä¸ºæŠŠä¸€ä¸ªé”™è¯¯çš„ UI ç•™åœ¨é‚£æ¯”å®Œå…¨ç§»é™¤å®ƒæ›´ç³Ÿç³•ã€‚è¿™ç§è®¾è®¡ï¼š
- ä¿ƒä½¿å¼€å‘è€…ä¸»åŠ¨æ·»åŠ é”™è¯¯è¾¹ç•Œ
- å¸®åŠ©å‘ç°éšè—çš„ bug
- æ¨èä½¿ç”¨ JS é”™è¯¯æŠ¥å‘ŠæœåŠ¡ï¼ˆå¦‚ Sentryï¼‰ç›‘æ§ç”Ÿäº§ç¯å¢ƒ

---

## ä¸ƒã€å¦‚ä½•å¤„ç†é”™è¯¯è¾¹ç•Œæ•è·ä¸åˆ°çš„é”™è¯¯ï¼Ÿ

### äº‹ä»¶å¤„ç†å‡½æ•°é”™è¯¯

ä½¿ç”¨ä¼ ç»Ÿçš„ JavaScript `try-catch`ï¼š

```javascript
function Button() {
  const handleClick = () => {
    try {
      doSomethingRisky();
    } catch (error) {
      console.error('Click error:', error);
      // å¤„ç†é”™è¯¯ï¼Œå¦‚æ˜¾ç¤ºæç¤º
    }
  };
  
  return <button onClick={handleClick}>Click</button>;
}
```

### å…¨å±€é”™è¯¯ç›‘å¬

```javascript
// æ•è·å¤§éƒ¨åˆ†åŒæ­¥ã€å®šæ—¶å™¨ã€Generator å¼‚æ­¥é”™è¯¯
window.addEventListener('error', (event) => {
  console.error('Global error:', event.error);
  // ä¸ŠæŠ¥é”™è¯¯
});

// æ•è· Promise åŠ async/await é”™è¯¯
window.addEventListener('unhandledrejection', (event) => {
  console.error('Unhandled rejection:', event.reason);
  // ä¸ŠæŠ¥é”™è¯¯
});
```

### é”™è¯¯å¤„ç†æ–¹æ¡ˆæ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    React é”™è¯¯å¤„ç†æ–¹æ¡ˆ                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  æ¸²æŸ“/ç”Ÿå‘½å‘¨æœŸ/æ„é€ å‡½æ•°é”™è¯¯  â†’  é”™è¯¯è¾¹ç•Œ                      â”‚
â”‚                                                             â”‚
â”‚  äº‹ä»¶å¤„ç†å‡½æ•°é”™è¯¯          â†’  try-catch                      â”‚
â”‚                                                             â”‚
â”‚  åŒæ­¥/å®šæ—¶å™¨é”™è¯¯           â†’  window.addEventListener('error')â”‚
â”‚                                                             â”‚
â”‚  Promise/async-await é”™è¯¯  â†’  window.addEventListener        â”‚
â”‚                               ('unhandledrejection')        â”‚
â”‚                                                             â”‚
â”‚  ç”Ÿäº§ç¯å¢ƒç›‘æ§              â†’  Sentry / LogRocket ç­‰æœåŠ¡      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…«ã€é¢è¯•é—®ç­”é€ŸæŸ¥

| é—®é¢˜ | ç­”æ¡ˆ |
|-----|------|
| ä»€ä¹ˆæ˜¯é”™è¯¯è¾¹ç•Œï¼Ÿ | èƒ½æ•è·å­ç»„ä»¶æ ‘ JS é”™è¯¯å¹¶å±•ç¤ºé™çº§ UI çš„ React ç»„ä»¶ |
| å¦‚ä½•åˆ›å»ºé”™è¯¯è¾¹ç•Œï¼Ÿ | class ç»„ä»¶å®ç° getDerivedStateFromError æˆ– componentDidCatch |
| é”™è¯¯è¾¹ç•Œèƒ½æ•è·å“ªäº›é”™è¯¯ï¼Ÿ | å­ç»„ä»¶æ¸²æŸ“æœŸé—´ã€ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€æ„é€ å‡½æ•°ä¸­çš„é”™è¯¯ |
| é”™è¯¯è¾¹ç•Œä¸èƒ½æ•è·å“ªäº›é”™è¯¯ï¼Ÿ | äº‹ä»¶å¤„ç†ã€å¼‚æ­¥ä»£ç ã€SSRã€è‡ªèº«é”™è¯¯ |
| ä¸ºä»€ä¹ˆäº‹ä»¶å¤„ç†é”™è¯¯æ•è·ä¸åˆ°ï¼Ÿ | äº‹ä»¶ä¸åœ¨æ¸²æŸ“æœŸé—´è§¦å‘ï¼ŒReact ä»èƒ½çŸ¥é“æ˜¾ç¤ºä»€ä¹ˆ |
| æœªæ•è·é”™è¯¯ä¼šæ€æ ·ï¼Ÿ | React 16+ æ•´ä¸ªç»„ä»¶æ ‘å¸è½½ï¼Œæ˜¾ç¤ºç™½å± |
| ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸçš„åŒºåˆ«ï¼Ÿ | getDerivedStateFromError ç”¨äºæ¸²æŸ“é™çº§ UIï¼›componentDidCatch ç”¨äºä¸ŠæŠ¥é”™è¯¯ |

---

## ä¹ã€ç»å…¸é¢è¯•ä»£ç 

### é¢è¯•é¢˜ 1ï¼šå®ç°ä¸€ä¸ªé”™è¯¯è¾¹ç•Œç»„ä»¶ ğŸ”¥

```javascript
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null, errorInfo: null };
  }

  // ç”¨äºæ¸²æŸ“é™çº§ UIï¼ˆRender é˜¶æ®µï¼Œä¸èƒ½æœ‰å‰¯ä½œç”¨ï¼‰
  static getDerivedStateFromError(error) {
    return { hasError: true, error };
  }

  // ç”¨äºæ‰“å°/ä¸ŠæŠ¥é”™è¯¯ï¼ˆCommit é˜¶æ®µï¼Œå¯ä»¥æœ‰å‰¯ä½œç”¨ï¼‰
  componentDidCatch(error, errorInfo) {
    this.setState({ errorInfo });
    // ä¸ŠæŠ¥é”™è¯¯åˆ°æœåŠ¡
    logErrorToService(error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      // æ¸²æŸ“é™çº§ UI
      return (
        <div className="error-fallback">
          <h2>å‡ºé”™äº†ï¼</h2>
          <details>
            <summary>æŸ¥çœ‹é”™è¯¯è¯¦æƒ…</summary>
            <pre>{this.state.error?.toString()}</pre>
            <pre>{this.state.errorInfo?.componentStack}</pre>
          </details>
          <button onClick={() => this.setState({ hasError: false })}>
            é‡è¯•
          </button>
        </div>
      );
    }

    return this.props.children;
  }
}

// ä½¿ç”¨
<ErrorBoundary>
  <MyComponent />
</ErrorBoundary>
```

### é¢è¯•é¢˜ 2ï¼šå¸¦é‡è¯•åŠŸèƒ½çš„é”™è¯¯è¾¹ç•Œ ğŸ”¥

```javascript
class RetryErrorBoundary extends React.Component {
  state = { hasError: false, retryCount: 0 };
  
  static getDerivedStateFromError(error) {
    return { hasError: true };
  }
  
  componentDidCatch(error, info) {
    console.error('Error caught:', error, info);
  }
  
  handleRetry = () => {
    this.setState(prev => ({
      hasError: false,
      retryCount: prev.retryCount + 1
    }));
  };
  
  render() {
    if (this.state.hasError) {
      return (
        <div>
          <p>åŠ è½½å¤±è´¥ï¼Œå·²é‡è¯• {this.state.retryCount} æ¬¡</p>
          <button onClick={this.handleRetry}>ç‚¹å‡»é‡è¯•</button>
        </div>
      );
    }
    
    // key å˜åŒ–ä¼šå¼ºåˆ¶å­ç»„ä»¶é‡æ–°æŒ‚è½½
    return (
      <React.Fragment key={this.state.retryCount}>
        {this.props.children}
      </React.Fragment>
    );
  }
}
```

### é¢è¯•é¢˜ 3ï¼šä½¿ç”¨ react-error-boundary åº“ï¼ˆæ¨èï¼‰â­

```javascript
import { ErrorBoundary } from 'react-error-boundary';

// é™çº§ UI ç»„ä»¶
function ErrorFallback({ error, resetErrorBoundary }) {
  return (
    <div role="alert">
      <p>Something went wrong:</p>
      <pre>{error.message}</pre>
      <button onClick={resetErrorBoundary}>Try again</button>
    </div>
  );
}

// ä½¿ç”¨
function App() {
  return (
    <ErrorBoundary
      FallbackComponent={ErrorFallback}
      onError={(error, info) => logErrorToService(error, info)}
      onReset={() => {
        // é‡ç½®åº”ç”¨çŠ¶æ€
      }}
    >
      <MyComponent />
    </ErrorBoundary>
  );
}
```

### é¢è¯•é¢˜ 4ï¼šå‡½æ•°ç»„ä»¶ä¸­å¤„ç†äº‹ä»¶é”™è¯¯ â­

```javascript
function useErrorHandler() {
  const [error, setError] = useState(null);

  const handleError = useCallback((error) => {
    setError(error);
    // ä¸ŠæŠ¥é”™è¯¯
    logErrorToService(error);
  }, []);

  const resetError = useCallback(() => {
    setError(null);
  }, []);

  // åˆ›å»ºå®‰å…¨çš„äº‹ä»¶å¤„ç†åŒ…è£…å™¨
  const withErrorHandling = useCallback((fn) => {
    return async (...args) => {
      try {
        await fn(...args);
      } catch (error) {
        handleError(error);
      }
    };
  }, [handleError]);

  return { error, resetError, withErrorHandling };
}

// ä½¿ç”¨
function MyComponent() {
  const { error, resetError, withErrorHandling } = useErrorHandler();

  const handleClick = withErrorHandling(async () => {
    const data = await fetchData();  // å¯èƒ½æŠ›é”™
    console.log(data);
  });

  if (error) {
    return (
      <div>
        <p>æ“ä½œå¤±è´¥: {error.message}</p>
        <button onClick={resetError}>é‡è¯•</button>
      </div>
    );
  }

  return <button onClick={handleClick}>è·å–æ•°æ®</button>;
}
```

### é¢è¯•é¢˜ 5ï¼šå…¨å±€é”™è¯¯ç›‘å¬ Hook â­

```javascript
function useGlobalErrorHandler(onError) {
  useEffect(() => {
    // åŒæ­¥é”™è¯¯
    const handleError = (event) => {
      onError(event.error, 'sync');
    };

    // Promise é”™è¯¯
    const handleRejection = (event) => {
      onError(event.reason, 'async');
    };

    window.addEventListener('error', handleError);
    window.addEventListener('unhandledrejection', handleRejection);

    return () => {
      window.removeEventListener('error', handleError);
      window.removeEventListener('unhandledrejection', handleRejection);
    };
  }, [onError]);
}

// åœ¨ App é¡¶å±‚ä½¿ç”¨
function App() {
  useGlobalErrorHandler((error, type) => {
    console.error(`[${type}] Global error:`, error);
    // ä¸ŠæŠ¥åˆ° Sentry ç­‰æœåŠ¡
  });

  return <MainContent />;
}
```

---

## åã€æ ¸å¿ƒè¦ç‚¹æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    React é”™è¯¯è¾¹ç•Œè¦ç‚¹                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å®šä¹‰æ–¹å¼   â†’  class ç»„ä»¶ + getDerivedStateFromError æˆ–          â”‚
â”‚                componentDidCatch                                â”‚
â”‚                                                                 â”‚
â”‚  èƒ½æ•è·     â†’  æ¸²æŸ“æœŸé—´ã€ç”Ÿå‘½å‘¨æœŸã€æ„é€ å‡½æ•°ä¸­çš„å­ç»„ä»¶é”™è¯¯          â”‚
â”‚                                                                 â”‚
â”‚  ä¸èƒ½æ•è·   â†’  äº‹ä»¶å¤„ç†ã€å¼‚æ­¥ä»£ç ã€SSRã€è‡ªèº«é”™è¯¯                  â”‚
â”‚                                                                 â”‚
â”‚  æœªæ•è·åæœ â†’  React 16+ æ•´ä¸ªç»„ä»¶æ ‘å¸è½½ï¼Œç™½å±                     â”‚
â”‚                                                                 â”‚
â”‚  æ”¾ç½®ä½ç½®   â†’  é¡¶å±‚è·¯ç”±ï¼ˆç»Ÿä¸€é™çº§ï¼‰æˆ– å•ç‹¬ç»„ä»¶ï¼ˆå±€éƒ¨é™çº§ï¼‰          â”‚
â”‚                                                                 â”‚
â”‚  äº‹ä»¶é”™è¯¯   â†’  try-catch æˆ– window.addEventListener              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  getDerivedStateFromError  â†’  Render é˜¶æ®µï¼Œè¿”å› stateï¼Œæ— å‰¯ä½œç”¨  â”‚
â”‚  componentDidCatch         â†’  Commit é˜¶æ®µï¼Œä¸ŠæŠ¥é”™è¯¯ï¼Œæœ‰å‰¯ä½œç”¨    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**ä¸€å¥è¯æ€»ç»“**ï¼šé”™è¯¯è¾¹ç•Œæ˜¯ React ç»„ä»¶ç‰ˆçš„ try-catchï¼Œç”¨äºæ•è·æ¸²æŸ“é˜¶æ®µçš„å­ç»„ä»¶é”™è¯¯å¹¶å±•ç¤ºé™çº§ UIï¼Œè€Œäº‹ä»¶å¤„ç†å’Œå¼‚æ­¥é”™è¯¯éœ€è¦ä¼ ç»Ÿçš„ try-catch æˆ–å…¨å±€ç›‘å¬æ¥å…œåº•ã€‚