# React æ ¸å¿ƒåŸç† - ç¬¬ä¸€æ€§åŸç†æ·±åº¦æ‹†è§£

## ä¸€ã€ç¬¬ä¸€æ€§åŸç†ï¼šReact çš„æ ¸å¿ƒé—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ

### æœ¬è´¨æ€è€ƒ

Web åº”ç”¨çš„æ ¸å¿ƒæŒ‘æˆ˜æ˜¯ï¼š**å¦‚ä½•é«˜æ•ˆåœ°å°†çŠ¶æ€æ˜ å°„åˆ° UIï¼Ÿ**

ä¼ ç»Ÿæ–¹å¼ç›´æ¥æ“ä½œ DOMï¼Œå­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š
1. **æ€§èƒ½å·®** â€” DOM æ“ä½œæ˜¯æ˜‚è´µçš„
2. **å¤æ‚åº¦é«˜** â€” æ‰‹åŠ¨è¿½è¸ªçŠ¶æ€å˜åŒ–ã€æ›´æ–° DOM

React çš„è§£å†³æ–¹æ¡ˆï¼š**Virtual DOM + Diff ç®—æ³• + å£°æ˜å¼ API**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    React æ ¸å¿ƒæ¶æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  å¼€å‘è€…                                                      â”‚
â”‚    â†“  å£°æ˜å¼ï¼šå‘Šè¯‰ React "UI åº”è¯¥æ˜¯ä»€ä¹ˆæ ·"                   â”‚
â”‚  React                                                      â”‚
â”‚    â†“  Virtual DOMï¼šåœ¨å†…å­˜ä¸­ç»´æŠ¤ UI çš„è™šæ‹Ÿè¡¨ç¤º                â”‚
â”‚  Diff ç®—æ³•                                                   â”‚
â”‚    â†“  å¯¹æ¯”æ–°æ—§è™šæ‹Ÿ DOMï¼Œè®¡ç®—æœ€å°å˜æ›´                         â”‚
â”‚  Reconciliationï¼ˆåè°ƒï¼‰                                      â”‚
â”‚    â†“  å°†å˜æ›´åŒæ­¥åˆ°çœŸå® DOM                                   â”‚
â”‚  çœŸå® DOM                                                    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€ä»€ä¹ˆæ˜¯ Virtual DOMï¼Ÿ

### å®šä¹‰

Virtual DOM æ˜¯ä¸€ç§**ç¼–ç¨‹æ¦‚å¿µ**ï¼ŒUI ä»¥"è™šæ‹Ÿçš„"è¡¨ç°å½¢å¼è¢«ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚

### æ ¸å¿ƒä»·å€¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Virtual DOM çš„ä½œç”¨                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. å£°æ˜å¼ API                                               â”‚
â”‚     â€¢ å‘Šè¯‰ React UI åº”è¯¥æ˜¯ä»€ä¹ˆçŠ¶æ€                           â”‚
â”‚     â€¢ React ç¡®ä¿ DOM åŒ¹é…è¯¥çŠ¶æ€                              â”‚
â”‚     â€¢ å¼€å‘è€…æ— éœ€å…³å¿ƒå±æ€§æ“ä½œã€äº‹ä»¶å¤„ç†ã€DOM æ›´æ–°              â”‚
â”‚                                                             â”‚
â”‚  2. æ”¯æŒ Diff ç®—æ³•                                           â”‚
â”‚     â€¢ å¯¹æ¯”æ–°æ—§è™šæ‹Ÿ DOM                                       â”‚
â”‚     â€¢ è®¡ç®—æœ€å° DOM æ“ä½œ                                      â”‚
â”‚                                                             â”‚
â”‚  3. è·¨å¹³å°èƒ½åŠ›                                               â”‚
â”‚     â€¢ ReactDOM â†’ Web                                        â”‚
â”‚     â€¢ ReactNative â†’ iOS/Android                             â”‚
â”‚     â€¢ ReactCanvas â†’ Canvas                                  â”‚
â”‚                                                             â”‚
â”‚  4. åè°ƒç­–ç•¥                                                 â”‚
â”‚     â€¢ æ”¯æŒä¼˜å…ˆçº§è°ƒåº¦                                         â”‚
â”‚     â€¢ æ”¯æŒå¯ä¸­æ–­çš„æ¸²æŸ“ï¼ˆFiberï¼‰                              â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Virtual DOM åœ¨ React ä¸­çš„è¡¨ç°

| æ¦‚å¿µ | è¯´æ˜ |
|-----|------|
| **React Element** | è™šæ‹Ÿ DOM èŠ‚ç‚¹ï¼Œä»£è¡¨ç”¨æˆ·ç•Œé¢çš„å¯¹è±¡ |
| **Fiber** | å†…éƒ¨å¯¹è±¡ï¼Œå­˜æ”¾ç»„ä»¶æ ‘çš„é™„åŠ ä¿¡æ¯ |
| **React Fiber** | åè°ƒå¼•æ“ï¼Œä½¿ Virtual DOM å¯ä»¥å¢é‡å¼æ¸²æŸ“ |

---

## ä¸‰ã€ä»€ä¹ˆæ˜¯ React Diffï¼Ÿå¯¹æ¯” Vue Diff

### ä¼ ç»Ÿ Diff çš„é—®é¢˜

å°†æ–°æ—§è™šæ‹Ÿ DOM çœ‹ä½œä¸¤æ£µæ ‘ï¼ŒèŠ‚ç‚¹ä¸ªæ•°ä¸º nï¼š
- å·¦ä¾§æ ‘çš„èŠ‚ç‚¹ä¸å³ä¾§æ ‘ä¸€ä¸€å¯¹æ¯”ï¼š**O(nÂ²)**
- æ‰¾åˆ°èŠ‚ç‚¹åè¿˜éœ€æ‰¾åˆé€‚ä½ç½®ï¼š**O(n)**
- æ€»å¤æ‚åº¦ï¼š**O(nÂ³)**

### React Diff çš„ä¼˜åŒ–ç­–ç•¥

React åŸºäºä¸¤ä¸ªå‡è®¾ï¼Œå°†å¤æ‚åº¦é™åˆ° **O(n)**ï¼š

1. **ä¸¤ä¸ªä¸åŒç±»å‹çš„å…ƒç´ ä¼šäº§ç”Ÿä¸åŒçš„æ ‘**
2. **é€šè¿‡ key å±æ€§æ ‡è¯†å“ªäº›å­å…ƒç´ åœ¨ä¸åŒæ¸²æŸ“ä¸‹å¯ä»¥ä¿æŒä¸å˜**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    React Diff ä¸‰å±‚ç­–ç•¥                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. Tree Diffï¼ˆæ ‘å±‚çº§ï¼‰                                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚     â”‚ â€¢ åªæ¯”è¾ƒåŒä¸€å±‚çº§çš„èŠ‚ç‚¹                         â”‚       â”‚
â”‚     â”‚ â€¢ é€šè¿‡ updateDepth æ§åˆ¶å±‚çº§                   â”‚       â”‚
â”‚     â”‚ â€¢ é¿å…è·¨å±‚çº§ç§»åŠ¨ï¼Œä¼˜å…ˆç”¨ CSS æ§åˆ¶æ˜¾ç¤ºéšè—      â”‚       â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                             â”‚
â”‚  2. Component Diffï¼ˆç»„ä»¶å±‚çº§ï¼‰                               â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚     â”‚ åŒç±»å‹ç»„ä»¶ï¼š                                   â”‚       â”‚
â”‚     â”‚   â€¢ å®ä¾‹ä¿æŒä¸å˜ï¼Œä¿æŒ state ä¸€è‡´             â”‚       â”‚
â”‚     â”‚   â€¢ æ›´æ–° propsï¼Œè°ƒç”¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•              â”‚       â”‚
â”‚     â”‚   â€¢ è°ƒç”¨ render()ï¼Œé€’å½’ diff å­èŠ‚ç‚¹           â”‚       â”‚
â”‚     â”‚   â€¢ å¯ç”¨ shouldComponentUpdate æ‰‹åŠ¨ä¼˜åŒ–       â”‚       â”‚
â”‚     â”‚                                               â”‚       â”‚
â”‚     â”‚ ä¸åŒç±»å‹ç»„ä»¶ï¼š                                 â”‚       â”‚
â”‚     â”‚   â€¢ åˆ é™¤æ—§ç»„ä»¶ï¼Œåˆ›å»ºæ–°ç»„ä»¶                     â”‚       â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                             â”‚
â”‚  3. Element Diffï¼ˆå…ƒç´ å±‚çº§ï¼‰                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚     â”‚ â€¢ é»˜è®¤éå†å­å…ƒç´ åˆ—è¡¨ï¼Œå·®å¼‚äº§ç”Ÿ mutation       â”‚       â”‚
â”‚     â”‚ â€¢ ç”¨ key æ ‡è¯†èŠ‚ç‚¹ï¼Œé¿å…ä½¿ç”¨ index             â”‚       â”‚
â”‚     â”‚ â€¢ åªé¡ºåºç§»åŠ¨ä½ç½®å˜åˆ°å‰é¢çš„èŠ‚ç‚¹                 â”‚       â”‚
â”‚     â”‚ â€¢ ç›¸åŒç±»å‹ä¿ç•™ DOMï¼Œä»…æ›´æ–°æ”¹å˜çš„å±æ€§          â”‚       â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Tree Diff æµç¨‹

```
æ—§æ ‘:          æ–°æ ‘:           æ“ä½œ:
   A              A            1. æ¯”è¾ƒæ ¹èŠ‚ç‚¹ A (ç›¸åŒ,ä¿ç•™)
  / \            / \           2. æ¯”è¾ƒ B (ç›¸åŒ,ä¿ç•™)
 B   C          B   D          3. æ¯”è¾ƒ C vs D (ä¸åŒ)
                                  - åˆ é™¤ C
                                  - åˆ›å»º D
```

### Vue Diff vs React Diff

| ç‰¹æ€§ | React Diff | Vue 2.x Diff | Vue 3.x Diff |
|-----|-----------|--------------|--------------|
| åŸºæœ¬ç­–ç•¥ | åŒå±‚æ¯”è¾ƒ | åŒå±‚æ¯”è¾ƒ | åŒå±‚æ¯”è¾ƒ |
| å­èŠ‚ç‚¹å¯¹æ¯” | å•å‘éå† | åŒç«¯å¯¹æ¯”ï¼ˆåŒæŒ‡é’ˆï¼‰ | åŒç«¯å¯¹æ¯” + æœ€é•¿é€’å¢å­åºåˆ— |
| é™æ€ä¼˜åŒ– | æ—  | æ—  | é™æ€æ ‡è®° hoistStatic |
| äº‹ä»¶ç¼“å­˜ | æ—  | æ—  | cacheHandlers |

### Vue 2.x åŒç«¯å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Vue 2.x updateChildren                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  è™šæ‹Ÿ DOM:  oldStart â†’  â† oldEnd                            â”‚
â”‚  çœŸå® DOM:  newStart â†’  â† newEnd                            â”‚
â”‚                                                             â”‚
â”‚  æ¯”è¾ƒé¡ºåº:                                                   â”‚
â”‚  1. oldStart vs newStart                                    â”‚
â”‚  2. oldEnd vs newEnd                                        â”‚
â”‚  3. oldStart vs newEnd                                      â”‚
â”‚  4. oldEnd vs newStart                                      â”‚
â”‚  5. éƒ½ä¸åŒ¹é… â†’ ç”¨ key æŸ¥æ‰¾                                   â”‚
â”‚                                                             â”‚
â”‚  ä¸¤ç«¯å‘ä¸­é—´æ”¶æ‹¢ï¼Œç›´åˆ° å·¦æŒ‡é’ˆ > å³æŒ‡é’ˆ                         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Vue 3.x ä¼˜åŒ–

```javascript
// 1. é™æ€æå‡ hoistStatic
// ä¸å‚ä¸æ›´æ–°çš„å…ƒç´ ï¼Œåªåˆ›å»ºä¸€æ¬¡ï¼Œæ¸²æŸ“æ—¶ç›´æ¥å¤ç”¨

// 2. äº‹ä»¶ç¼“å­˜ cacheHandlers
// ç¼“å­˜å‡½æ•°ï¼Œä¸è¿½è¸ªå˜åŒ–ï¼Œæå‡æ€§èƒ½

// 3. æœ€é•¿é€’å¢å­åºåˆ—
// å‡å°‘ DOM ç§»åŠ¨æ“ä½œ
```

---

## å››ã€ä»€ä¹ˆæ˜¯ React Concurrent æ¨¡å¼ï¼Ÿ

### å®šä¹‰

Concurrent æ¨¡å¼æ˜¯ä¸€ç»„ React æ–°åŠŸèƒ½ï¼Œå¸®åŠ©åº”ç”¨**ä¿æŒå“åº”**ï¼Œå¹¶æ ¹æ®ç”¨æˆ·è®¾å¤‡æ€§èƒ½å’Œç½‘é€Ÿè¿›è¡Œé€‚å½“è°ƒæ•´ã€‚

### æ ¸å¿ƒç‰¹æ€§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Concurrent æ¨¡å¼ç‰¹æ€§                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. å¯ä¸­æ–­æ¸²æŸ“                                               â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚ â€¢ ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„æ›´æ–°å»åšæ›´é‡è¦çš„äº‹æƒ…              â”‚    â”‚
â”‚     â”‚ â€¢ ç„¶åå†å›åˆ°ä¹‹å‰æ­£åœ¨åšçš„å·¥ä½œ                      â”‚    â”‚
â”‚     â”‚ â€¢ å‡å°‘é˜²æŠ–å’ŒèŠ‚æµçš„éœ€æ±‚                            â”‚    â”‚
â”‚     â”‚ â€¢ æ¸²æŸ“å¯ä»¥ç»ˆç«¯ï¼Œä¸éœ€è¦äººä¸ºå»¶è¿Ÿä»¥é¿å…å¡é¡¿          â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚  2. æœ‰æ„çš„åŠ è½½é¡ºåº                                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚ â€¢ React é¦–å…ˆåœ¨å†…å­˜ä¸­å‡†å¤‡æ–°å±å¹•                   â”‚    â”‚
â”‚     â”‚ â€¢ ä¹‹å‰ç»§ç»­æ˜¾ç¤ºå®Œå…¨äº¤äº’çš„æ—§å±å¹•                   â”‚    â”‚
â”‚     â”‚ â€¢ æ–°å±å¹•å‡†å¤‡å°±ç»ªåï¼Œè·³è½¬åˆ°æ–°å±å¹•                 â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚  3. å¹¶å‘                                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚ â€¢ React å¯ä»¥åŒæ—¶æ›´æ–°å¤šä¸ªçŠ¶æ€                     â”‚    â”‚
â”‚     â”‚ â€¢ CPU å¯†é›†æ›´æ–°å¯ä»¥"ä¸­æ–­"å·²å¼€å§‹çš„æ¸²æŸ“             â”‚    â”‚
â”‚     â”‚ â€¢ IO å¯†é›†æ›´æ–°å¯ä»¥åœ¨æ•°æ®åˆ°è¾¾å‰å°±å¼€å§‹æ¸²æŸ“          â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¼€å¯æ–¹å¼

```javascript
// Legacy æ¨¡å¼ï¼ˆå½“å‰é»˜è®¤ï¼‰
ReactDOM.render(<App />, rootNode);

// Blocking æ¨¡å¼ï¼ˆè¿‡æ¸¡ï¼‰
ReactDOM.createBlockingRoot(rootNode).render(<App />);

// Concurrent æ¨¡å¼ï¼ˆæœªæ¥é»˜è®¤ï¼‰
ReactDOM.createRoot(rootNode).render(<App />);
```

### Concurrent æ¨¡å¼å¸¸ç”¨ API

| API | ä½œç”¨ |
|-----|------|
| **Suspense** | å…è®¸ç»„ä»¶åœ¨æ¸²æŸ“å‰"ç­‰å¾…"ï¼Œæ˜¾ç¤º fallback |
| **SuspenseList** | ç¼–æ’å¤šä¸ª Suspense ç»„ä»¶çš„æ˜¾ç¤ºé¡ºåº |
| **useTransition** | é¿å…ä¸å¿…è¦çš„åŠ è½½çŠ¶æ€ï¼Œæ¨è¿Ÿéç´§æ€¥æ›´æ–° |
| **useDeferredValue** | è¿”å›å»¶è¿Ÿå“åº”çš„å€¼ï¼Œä¿æŒæ¥å£å“åº”æ€§ |

---

## äº”ã€ä»€ä¹ˆæ˜¯ Suspenseï¼Ÿ

### å®šä¹‰

Suspense è®©ç»„ä»¶"ç­‰å¾…"æŸä¸ªå¼‚æ­¥æ“ä½œï¼Œç›´åˆ°è¯¥æ“ä½œç»“æŸå³å¯æ¸²æŸ“ã€‚

### æ ¸å¿ƒç†è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Suspense æ˜¯ä»€ä¹ˆ / ä¸æ˜¯ä»€ä¹ˆ                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Suspense ä¸æ˜¯ä»€ä¹ˆï¼š                                         â”‚
â”‚  âŒ ä¸æ˜¯æ•°æ®è·å–çš„ä¸€ç§å®ç°                                   â”‚
â”‚  âŒ ä¸æ˜¯ç›´æ¥ç”¨äºæ•°æ®è·å–çš„å®¢æˆ·ç«¯                             â”‚
â”‚  âŒ ä¸ä½¿æ•°æ®è·å–ä¸è§†å›¾å±‚ä»£ç è€¦åˆ                             â”‚
â”‚                                                             â”‚
â”‚  Suspense æ˜¯ä»€ä¹ˆï¼š                                           â”‚
â”‚  âœ… ä¸€ç§æœºåˆ¶ï¼Œè®©æ•°æ®è¯·æ±‚åº“å‘ React é€šä¿¡                      â”‚
â”‚  âœ… é€šä¿¡å†…å®¹ï¼šæŸä¸ªç»„ä»¶æ­£åœ¨è¯»å–çš„æ•°æ®å½“å‰ä»ä¸å¯ç”¨             â”‚
â”‚  âœ… React å¯ä»¥ç»§ç»­ç­‰å¾…æ•°æ®è¿”å›å¹¶æ›´æ–° UI                      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Suspense çš„å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Suspense æ¸²æŸ“æµç¨‹                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ä¼ ç»Ÿæ–¹å¼ï¼ˆFetch-on-Renderï¼‰ï¼š                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ å‘é€è¯·æ±‚ â†’ ç­‰å¾…å“åº” â†’ æ›´æ–° State â†’ å¼€å§‹æ¸²æŸ“      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                             â”‚
â”‚  Suspense æ–¹å¼ï¼ˆRender-as-You-Fetchï¼‰ï¼š                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ å‘é€è¯·æ±‚ â†’ é©¬ä¸Šå¼€å§‹æ¸²æŸ“                          â”‚       â”‚
â”‚  â”‚         â†“                                       â”‚       â”‚
â”‚  â”‚ æ•°æ®æ²¡è·å–å®Œæ¯• â†’ ç»„ä»¶å¤„äº"æŒ‚èµ·"çŠ¶æ€              â”‚       â”‚
â”‚  â”‚         â†“                                       â”‚       â”‚
â”‚  â”‚ React è·³è¿‡è¯¥ç»„ä»¶ï¼Œç»§ç»­æ¸²æŸ“å…¶ä»–ç»„ä»¶               â”‚       â”‚
â”‚  â”‚         â†“                                       â”‚       â”‚
â”‚  â”‚ æ•°æ®åˆ°æ¥ â†’ é‡æ–°æ¸²æŸ“ï¼Œå¯èƒ½æ¸²æŸ“å‡ºæ›´å®Œæ•´çš„æ ‘        â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Suspense çš„ä»·å€¼

1. **è®©æ•°æ®è·å–åº“ä¸ React ç´§å¯†æ•´åˆ**
2. **è®©å¼€å‘è€…æœ‰é’ˆå¯¹æ€§åœ°å®‰æ’åŠ è½½çŠ¶æ€å±•ç¤º**
3. **æ¶ˆé™¤ race conditions**ï¼ˆç«æ€æ¡ä»¶ï¼‰
   - ä¸æ˜¯ç­‰å“åº”è¿”å›åæ‰æ›´æ–° State
   - è€Œæ˜¯å‘å‡ºè¯·æ±‚åï¼Œé©¬ä¸Šæ›´æ–° State + å¼€å§‹æ¸²æŸ“

---

## å…­ã€React å¦‚ä½•å®šä¹‰ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Ÿ

### ä¸ºä»€ä¹ˆéœ€è¦ä¼˜å…ˆçº§ï¼Ÿ

äº§ç”Ÿæ›´æ–°å¯¹è±¡åï¼ŒReact ä¼šæ‰§è¡Œä¸€ä¸ªæ›´æ–°ä»»åŠ¡ã€‚ä¼˜å…ˆçº§ç”¨æ¥**åŒºåˆ†å¤šä¸ªæ›´æ–°ä»»åŠ¡çš„ç´§æ€¥ç¨‹åº¦**ã€‚

### ä¼˜å…ˆçº§è°ƒåº¦è§„åˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä»»åŠ¡ä¼˜å…ˆçº§è°ƒåº¦                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  å¯¹æ¯”å‰åä¸¤æ¬¡æ›´æ–°çš„ä»»åŠ¡ä¼˜å…ˆçº§ï¼š                              â”‚
â”‚                                                             â”‚
â”‚  åè€… > å‰è€…ï¼š                                               â”‚
â”‚    â†’ React ä¼šå–æ¶ˆå‰è€…çš„ä»»åŠ¡è°ƒåº¦                             â”‚
â”‚                                                             â”‚
â”‚  åè€… = å‰è€…ï¼š                                               â”‚
â”‚    â†’ React å°†åŒç­‰ä¼˜å…ˆçº§çš„æ›´æ–°æ”¶æ•›åˆ°ä¸€æ¬¡ä»»åŠ¡ä¸­                â”‚
â”‚                                                             â”‚
â”‚  åè€… < å‰è€…ï¼š                                               â”‚
â”‚    â†’ React ä¼šåœ¨å‰è€…æ›´æ–°å®Œæˆåï¼Œå†å¯¹åè€…å‘èµ·ä»»åŠ¡è°ƒåº¦          â”‚
â”‚                                                             â”‚
â”‚  æ„ä¹‰ï¼š                                                      â”‚
â”‚  â€¢ ä¿è¯é«˜ä¼˜å…ˆçº§ä»»åŠ¡åŠæ—¶å“åº”                                  â”‚
â”‚  â€¢ æ”¶æ•›åŒç­‰ä¼˜å…ˆçº§çš„ä»»åŠ¡è°ƒåº¦                                  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸‰ç±»ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ç±»å‹ | è¯´æ˜ | å¯¹åº”æ¨¡å¼ |
|-----------|------|---------|
| **åŒæ­¥ä¼˜å…ˆçº§** | æœ€é«˜ï¼Œç«‹å³æ‰§è¡Œ | Legacy åŒæ­¥æ¸²æŸ“æ¨¡å¼ |
| **åŒæ­¥æ‰¹é‡ä¼˜å…ˆçº§** | æ‰¹é‡æ›´æ–° | Blocking æ¨¡å¼ |
| **Concurrent æ¨¡å¼ä¼˜å…ˆçº§** | æ ¹æ®äº¤äº’ç±»å‹åŒºåˆ† | Concurrent æ¨¡å¼ |

### Lane Priorityï¼ˆè½¦é“ä¼˜å…ˆçº§ï¼‰

```javascript
// LanePriority è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜
export const SyncLanePriority: LanePriority = 17;           // åŒæ­¥
export const SyncBatchedLanePriority: LanePriority = 16;    // åŒæ­¥æ‰¹é‡
const InputDiscreteHydrationLanePriority: LanePriority = 15;
export const InputDiscreteLanePriority: LanePriority = 14;  // ç¦»æ•£è¾“å…¥ï¼ˆç‚¹å‡»ï¼‰
const InputContinuousHydrationLanePriority: LanePriority = 13;
export const InputContinuousLanePriority: LanePriority = 12; // è¿ç»­è¾“å…¥ï¼ˆæ»šåŠ¨ï¼‰
const DefaultHydrationLanePriority: LanePriority = 11;
export const DefaultLanePriority: LanePriority = 10;        // é»˜è®¤
const TransitionShortHydrationLanePriority: LanePriority = 9;
export const TransitionShortLanePriority: LanePriority = 8;  // çŸ­è¿‡æ¸¡
const TransitionLongHydrationLanePriority: LanePriority = 7;
export const TransitionLongLanePriority: LanePriority = 6;   // é•¿è¿‡æ¸¡
const RetryLanePriority: LanePriority = 5;                   // é‡è¯•
const SelectiveHydrationLanePriority: LanePriority = 4;
const IdleHydrationLanePriority: LanePriority = 3;
const IdleLanePriority: LanePriority = 2;                    // ç©ºé—²
const OffscreenLanePriority: LanePriority = 1;               // ç¦»å±
export const NoLanePriority: LanePriority = 0;               // æ— 
```

### ä¼˜å…ˆçº§ä¸äººæœºäº¤äº’

| äº¤äº’ç±»å‹ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|---------|-------|------|
| ç”¨æˆ·è¾“å…¥ | æœ€é«˜ | ç‚¹å‡»ã€è¾“å…¥æ¡†è¾“å…¥ |
| æ‚¬åœ | é«˜ | é¼ æ ‡æ‚¬åœæ•ˆæœ |
| é¡µé¢è½¬æ¢ | ä¸­ | è·¯ç”±åˆ‡æ¢ |
| æ•°æ®è·å– | ä½ | å¼‚æ­¥æ•°æ®åŠ è½½ |
| ç¦»å±æ¸²æŸ“ | æœ€ä½ | é¢„æ¸²æŸ“ä¸å¯è§å†…å®¹ |

---

## ä¸ƒã€é¢è¯•é—®ç­”é€ŸæŸ¥

| é—®é¢˜ | ç­”æ¡ˆ |
|-----|------|
| Virtual DOM æ˜¯ä»€ä¹ˆï¼Ÿ | UI çš„è™šæ‹Ÿè¡¨ç¤ºï¼Œä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œé€šè¿‡ Diff ç®—æ³•ä¸çœŸå® DOM åŒæ­¥ |
| Virtual DOM æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ | å£°æ˜å¼ APIã€Diff ä¼˜åŒ–ã€è·¨å¹³å°ã€å¯ä¸­æ–­æ¸²æŸ“ |
| React Diff å¤æ‚åº¦ï¼Ÿ | O(n)ï¼ŒåŸºäºä¸¤ä¸ªå‡è®¾ï¼šä¸åŒç±»å‹äº§ç”Ÿä¸åŒæ ‘ã€key æ ‡è¯†å¯å¤ç”¨èŠ‚ç‚¹ |
| React å’Œ Vue Diff åŒºåˆ«ï¼Ÿ | React å•å‘éå†ï¼ŒVue åŒç«¯å¯¹æ¯”ï¼›Vue 3 è¿˜æœ‰é™æ€æå‡å’Œäº‹ä»¶ç¼“å­˜ |
| Concurrent æ¨¡å¼æ˜¯ä»€ä¹ˆï¼Ÿ | å¯ä¸­æ–­æ¸²æŸ“ã€æœ‰æ„çš„åŠ è½½é¡ºåºã€å¹¶å‘æ›´æ–°å¤šä¸ªçŠ¶æ€ |
| Suspense æ˜¯ä»€ä¹ˆï¼Ÿ | è®©ç»„ä»¶ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆå†æ¸²æŸ“çš„æœºåˆ¶ï¼Œä¸æ˜¯æ•°æ®è·å–åº“ |
| ä»»åŠ¡ä¼˜å…ˆçº§æœ‰ä»€ä¹ˆç”¨ï¼Ÿ | ä¿è¯é«˜ä¼˜å…ˆçº§ä»»åŠ¡åŠæ—¶å“åº”ï¼Œæ”¶æ•›åŒç­‰ä¼˜å…ˆçº§ä»»åŠ¡ |

---

## å…«ã€ç»å…¸é¢è¯•ä»£ç 

### é¢è¯•é¢˜ 1ï¼šVirtual DOM ç»“æ„ ğŸ”¥

```javascript
// Virtual DOM æœ¬è´¨æ˜¯ JavaScript å¯¹è±¡
const vdom = {
  type: 'div',
  props: {
    className: 'container',
    children: [
      {
        type: 'h1',
        props: {
          children: 'Hello'
        }
      },
      {
        type: 'p',
        props: {
          children: 'World'
        }
      }
    ]
  }
};

// å¯¹åº”çš„ JSX
<div className="container">
  <h1>Hello</h1>
  <p>World</p>
</div>
```

### é¢è¯•é¢˜ 2ï¼šç®€æ˜“ Diff ç®—æ³•å®ç° ğŸ”¥

```javascript
function diff(oldTree, newTree) {
  const patches = [];

  // 1. èŠ‚ç‚¹ç±»å‹ä¸åŒï¼šæ›¿æ¢
  if (oldTree.type !== newTree.type) {
    patches.push({ type: 'REPLACE', newTree });
    return patches;
  }

  // 2. èŠ‚ç‚¹ç±»å‹ç›¸åŒï¼šæ¯”è¾ƒå±æ€§
  const propsPatches = diffProps(oldTree.props, newTree.props);
  if (Object.keys(propsPatches).length > 0) {
    patches.push({ type: 'PROPS', propsPatches });
  }

  // 3. é€’å½’æ¯”è¾ƒå­èŠ‚ç‚¹
  const childrenPatches = diffChildren(
    oldTree.props.children,
    newTree.props.children
  );
  patches.push(...childrenPatches);

  return patches;
}

function diffProps(oldProps, newProps) {
  const patches = {};
  
  // æŸ¥æ‰¾æ”¹å˜çš„å±æ€§
  for (const key in newProps) {
    if (oldProps[key] !== newProps[key]) {
      patches[key] = newProps[key];
    }
  }
  
  // æŸ¥æ‰¾åˆ é™¤çš„å±æ€§
  for (const key in oldProps) {
    if (!(key in newProps)) {
      patches[key] = undefined;
    }
  }
  
  return patches;
}
```

### é¢è¯•é¢˜ 3ï¼šSuspense ä½¿ç”¨ç¤ºä¾‹ ğŸ”¥

```javascript
import { Suspense } from 'react';

// åˆ›å»ºæ”¯æŒ Suspense çš„èµ„æº
function createResource(promise) {
  let status = 'pending';
  let result;
  
  const suspender = promise.then(
    data => { status = 'success'; result = data; },
    error => { status = 'error'; result = error; }
  );

  return {
    read() {
      if (status === 'pending') throw suspender;
      if (status === 'error') throw result;
      return result;
    }
  };
}

// ä½¿ç”¨èµ„æºçš„ç»„ä»¶
const userResource = createResource(fetchUser());

function UserProfile() {
  const user = userResource.read(); // å¦‚æœæœªå°±ç»ªï¼Œä¼šæŠ›å‡º Promise
  return <div>{user.name}</div>;
}

// ä½¿ç”¨ Suspense åŒ…è£¹
function App() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <UserProfile />
    </Suspense>
  );
}
```

### é¢è¯•é¢˜ 4ï¼šuseTransition ä½¿ç”¨ç¤ºä¾‹ â­

```javascript
import { useState, useTransition } from 'react';

function App() {
  const [tab, setTab] = useState('home');
  const [isPending, startTransition] = useTransition();

  const handleTabChange = (nextTab) => {
    // ç”¨ startTransition åŒ…è£¹éç´§æ€¥æ›´æ–°
    startTransition(() => {
      setTab(nextTab);
    });
  };

  return (
    <div>
      <button onClick={() => handleTabChange('home')}>Home</button>
      <button onClick={() => handleTabChange('profile')}>Profile</button>
      
      {isPending && <div>Loading...</div>}
      
      <TabContent tab={tab} />
    </div>
  );
}

// å³ä½¿ TabContent æ¸²æŸ“å¾ˆæ…¢ï¼Œç‚¹å‡»æŒ‰é’®ä¹Ÿä¼šç«‹å³å“åº”
// æ—§å†…å®¹ä¼šä¿æŒæ˜¾ç¤ºï¼Œç›´åˆ°æ–°å†…å®¹å‡†å¤‡å¥½
```

### é¢è¯•é¢˜ 5ï¼škey çš„é‡è¦æ€§ â­

```javascript
// âŒ é”™è¯¯ï¼šä½¿ç”¨ index ä½œä¸º key
{items.map((item, index) => (
  <Item key={index} data={item} />
))}
// é—®é¢˜ï¼šå½“ items é¡ºåºæ”¹å˜æ—¶ï¼ŒReact ä¼šé”™è¯¯åœ°å¤ç”¨ç»„ä»¶å®ä¾‹

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å”¯ä¸€ä¸”ç¨³å®šçš„ id
{items.map(item => (
  <Item key={item.id} data={item} />
))}
// React å¯ä»¥æ­£ç¡®è¯†åˆ«å“ªäº›å…ƒç´ ç§»åŠ¨äº†ã€å“ªäº›æ˜¯æ–°å¢çš„

// æ¼”ç¤ºé—®é¢˜
// åŸå§‹: [A, B, C] â†’ key: [0, 1, 2]
// åˆ é™¤B: [A, C]   â†’ key: [0, 1]
// React è®¤ä¸º C æ˜¯ Bï¼ˆå› ä¸º key=1ï¼‰ï¼Œå¯¼è‡´çŠ¶æ€é”™ä¹±
```

---

## ä¹ã€æ ¸å¿ƒè¦ç‚¹æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    React æ ¸å¿ƒåŸç†è¦ç‚¹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Virtual DOM  â†’  UI çš„å†…å­˜è¡¨ç¤ºï¼Œå£°æ˜å¼ã€å¯ Diffã€è·¨å¹³å°        â”‚
â”‚                                                                â”‚
â”‚  React Diff   â†’  O(n) å¤æ‚åº¦ï¼Œä¸‰å±‚ç­–ç•¥ï¼šTree/Component/Element â”‚
â”‚                  å‡è®¾ï¼šä¸åŒç±»å‹äº§ç”Ÿä¸åŒæ ‘ï¼Œkey æ ‡è¯†å¯å¤ç”¨       â”‚
â”‚                                                                â”‚
â”‚  Vue Diff     â†’  åŒç«¯å¯¹æ¯”ï¼ˆVue 2ï¼‰ï¼Œæœ€é•¿é€’å¢å­åºåˆ—ï¼ˆVue 3ï¼‰    â”‚
â”‚                  é™æ€æå‡ã€äº‹ä»¶ç¼“å­˜ä¼˜åŒ–                         â”‚
â”‚                                                                â”‚
â”‚  Concurrent   â†’  å¯ä¸­æ–­æ¸²æŸ“ã€æœ‰æ„åŠ è½½é¡ºåºã€å¹¶å‘æ›´æ–°            â”‚
â”‚                                                                â”‚
â”‚  Suspense     â†’  ç»„ä»¶ç­‰å¾…å¼‚æ­¥æ“ä½œçš„æœºåˆ¶ï¼Œä¸æ˜¯æ•°æ®è·å–åº“        â”‚
â”‚                  å‘é€è¯·æ±‚å³å¼€å§‹æ¸²æŸ“ï¼Œæ¶ˆé™¤ç«æ€æ¡ä»¶               â”‚
â”‚                                                                â”‚
â”‚  ä¼˜å…ˆçº§       â†’  Lane Priorityï¼Œé«˜ä¼˜å…ˆçº§å“åº”ã€åŒç­‰æ”¶æ•›         â”‚
â”‚                  å¯¹åº”äººæœºäº¤äº’ç±»åˆ«ï¼šè¾“å…¥ > æ‚¬åœ > è½¬æ¢ > æ•°æ®    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**ä¸€å¥è¯æ€»ç»“**ï¼šReact é€šè¿‡ Virtual DOM å®ç°å£°æ˜å¼ UIï¼Œé€šè¿‡ Diff ç®—æ³•é«˜æ•ˆæ›´æ–°ï¼Œé€šè¿‡ Fiber æ¶æ„å®ç°å¯ä¸­æ–­æ¸²æŸ“å’Œä¼˜å…ˆçº§è°ƒåº¦ï¼Œæœ€ç»ˆç›®æ ‡æ˜¯è®©åº”ç”¨ä¿æŒæµç•…å“åº”çš„ç”¨æˆ·ä½“éªŒã€‚