# this指向 第一性原理拆解

# JavaScript `this` 第一性原理拆解

## 🎯 核心第一性原理

```
┌─────────────────────────────────────────────────────────┐
│  this 的本质：谁调用，指向谁（运行时动态绑定）           │
│                                                         │
│  this ≠ 定义时确定                                      │
│  this = 调用时确定                                      │
└─────────────────────────────────────────────────────────┘
```

---

## 📊 七种场景决策树

```
                    ┌──────────────┐
                    │  this 指向?  │
                    └──────┬───────┘
                           │
        ┌──────────────────┼──────────────────┐
        ▼                  ▼                  ▼
   ┌─────────┐       ┌──────────┐       ┌──────────┐
   │ 箭头函数 │       │ 普通函数  │       │   类    │
   └────┬────┘       └────┬─────┘       └────┬─────┘
        │                 │                  │
        ▼                 ▼                  ▼
   继承外层this      看调用方式           指向实例
```

---

## 🔬 七种场景详解

### 1️⃣ 全局上下文
```javascript
console.log(this === window); // true
```
```
┌─────────────────────────┐
│      全局环境            │
│  ┌─────────────────┐    │
│  │ this → window   │    │
│  └─────────────────┘    │
└─────────────────────────┘
```

---

### 2️⃣ 函数上下文（最复杂）

```
┌────────────────────────────────────────────────────┐
│                  函数调用方式                       │
├──────────────┬──────────────┬──────────────────────┤
│   调用方式    │   this指向   │        示例          │
├──────────────┼──────────────┼──────────────────────┤
│ obj.fn()     │     obj      │ 对象方法调用          │
│ fn()         │ window/undef │ 普通调用(严格模式不同) │
│ fn.call(o)   │      o       │ 显式绑定              │
│ fn.apply(o)  │      o       │ 显式绑定              │
│ fn.bind(o)() │      o       │ 硬绑定                │
└──────────────┴──────────────┴──────────────────────┘
```

**经典案例：**
```javascript
function add(c, d) {
  return this.a + this.b + c + d;
}
var o = {a: 1, b: 3};
add.call(o, 5, 7); // 16
```
```
        call(o, 5, 7)
             │
             ▼
┌─────────────────────────┐
│  this 被强制指向 o       │
│  this.a = 1             │
│  this.b = 3             │
│  1 + 3 + 5 + 7 = 16     │
└─────────────────────────┘
```

---

### 3️⃣ 类上下文

```javascript
class Car {
  constructor() {
    this.sayBye = this.sayBye.bind(this); // 绑定
  }
  sayHi() { console.log(`Hello from ${this.name}`); }
  get name() { return 'Ferrari'; }
}
```

```
┌─────────────────────────────────────────┐
│              new Car()                  │
│  ┌─────────────────────────────────┐    │
│  │  this → 新创建的实例对象         │    │
│  │  实例.sayHi() → this是实例      │    │
│  └─────────────────────────────────┘    │
└─────────────────────────────────────────┘
```

**⚠️ 陷阱案例：**
```javascript
const car = new Car();
const bird = new Bird(); // Bird.name = 'Tweety'

bird.sayHi = car.sayHi;
bird.sayHi(); // "Hello from Tweety" ← this变了！
```

```
  car.sayHi 赋值给 bird
         │
         ▼
┌─────────────────────────┐
│ bird.sayHi()            │
│ 调用者是 bird           │
│ this → bird             │
│ this.name → 'Tweety'    │
└─────────────────────────┘
```

---

### 4️⃣ 箭头函数（特殊！）

```
┌─────────────────────────────────────────────────────┐
│  箭头函数没有自己的 this                             │
│  ═══════════════════════                            │
│  它继承定义时外层作用域的 this（词法绑定）            │
└─────────────────────────────────────────────────────┘
```

```javascript
var foo = (() => this);
console.log(foo() === window); // true
```

```
定义时：
┌──────────────────────┐
│  全局作用域           │
│  this = window       │
│  ┌────────────────┐  │
│  │ 箭头函数        │  │
│  │ 继承外层this   │  │
│  │ = window       │  │
│  └────────────────┘  │
└──────────────────────┘
```

---

### 5️⃣ 原型链中的 this

```javascript
var o = {
  f: function() { return this.a + this.b; }
};
var p = Object.create(o);
p.a = 1; p.b = 4;
p.f(); // 5
```

```
┌─────────────┐
│      p      │  ← 调用者
│  a: 1       │
│  b: 4       │
│  [[Proto]]──┼──→ o (有方法f)
└─────────────┘
      │
      ▼
  p.f() → this指向p → 1+4=5
```

---

### 6️⃣ DOM 事件处理

```javascript
testBtn.addEventListener('click', function(e) {
  console.log(this === e.currentTarget); // true
  this.style.backgroundColor = 'blue';
});
```

```
┌─────────────────────────────────────┐
│         点击事件触发                 │
│  ┌─────────────────────────────┐    │
│  │ this → 绑定事件的DOM元素     │    │
│  │ this === e.currentTarget    │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
```

---

### 7️⃣ Getter/Setter

```javascript
var o = {
  a: 1, b: 2,
  get sum() { return this.a + this.b; }
};
o.sum; // 3
```
```
访问 o.sum
     │
     ▼
this 绑定到 o → 1 + 2 = 3
```

---

## 🧪 综合练习解析

```javascript
var length = 10;
function fn() { return this.length + 1; }
var obj = {
  length: 5,
  test1: function() { return fn(); },
  test2: fn
};
```

```
┌────────────────────────────────────────────────────────┐
│  调用                │  this指向  │  结果  │  原因      │
├─────────────────────┼───────────┼───────┼────────────┤
│ obj.test1.call()    │  window   │  11   │ fn()普通调用│
│ obj.test1()         │  window   │  11   │ fn()普通调用│
│ obj.test2.call()    │  window   │  11   │ call无参数  │
│ obj.test2()         │   obj     │   6   │ obj.方法()  │
└────────────────────────────────────────────────────────┘
```

**关键图解：**
```
obj.test1() 执行过程：
┌─────────────────────────────────┐
│ obj.test1()                     │
│      │                          │
│      ▼                          │
│ return fn()  ← 普通函数调用！    │
│      │                          │
│      ▼                          │
│ this → window                   │
│ window.length = 10              │
│ 10 + 1 = 11                     │
└─────────────────────────────────┘

obj.test2() 执行过程：
┌─────────────────────────────────┐
│ obj.test2()                     │
│      │                          │
│      ▼                          │
│ 作为obj的方法调用！              │
│      │                          │
│      ▼                          │
│ this → obj                      │
│ obj.length = 5                  │
│ 5 + 1 = 6                       │
└─────────────────────────────────┘
```

---

## 🔑 绑定优先级

```
┌─────────────────────────────────────────┐
│           优先级从高到低                 │
│  ════════════════════════               │
│  1. new 绑定                            │
│  2. 显式绑定 (call/apply/bind)          │
│  3. 隐式绑定 (obj.fn())                 │
│  4. 默认绑定 (window/undefined)         │
│                                         │
│  ⚡ 箭头函数：无视以上规则，看定义位置    │
└─────────────────────────────────────────┘
```

---

## 💎 核心奥义（一句话）

> **`this` 不看定义看调用：普通函数问"谁调用我"，箭头函数问"谁包裹我"。**







