# 手写 new - 第一性原理完全指南

> 🎯 **面试高频指数：★★★★☆**

---

## 📚 目录

1. [第一性原理：new 到底做了什么？](#第一性原理new-到底做了什么)
2. [new 的四个步骤](#new-的四个步骤)
3. [手写 new 实现](#手写-new-实现)
4. [深入理解每个步骤](#深入理解每个步骤)
5. [核心奥义](#核心奥义)

---

## 第一性原理：new 到底做了什么？

### 🧠 本质思考

**new 的本质 = 创建一个新对象 + 建立原型链接 + 绑定 this 执行构造函数**

```
┌─────────────────────────────────────────────────────────────────┐
│                      new 操作符的本质                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   function Person(name) {                                       │
│       this.name = name;                                         │
│   }                                                             │
│                                                                 │
│   const p = new Person('xiaoming');                            │
│                                                                 │
│   new 做了什么？                                                 │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                                                         │   │
│   │  1. 创建一个空对象 {}                                    │   │
│   │                  ↓                                      │   │
│   │  2. 空对象的 __proto__ → Person.prototype               │   │
│   │                  ↓                                      │   │
│   │  3. 执行 Person，this 指向这个空对象                     │   │
│   │                  ↓                                      │   │
│   │  4. 返回这个对象（除非构造函数返回了其他对象）            │   │
│   │                                                         │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   结果：p = { name: 'xiaoming', __proto__: Person.prototype }   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## new 的四个步骤

### 📋 官方步骤总结

| 步骤 | 描述 |
|------|------|
| **Step 1** | 第一参数作为构造函数，其余参数作为构造函数参数 |
| **Step 2** | 继承构造函数原型创建新对象 |
| **Step 3** | 执行构造函数 |
| **Step 4** | 结果为对象，返回结果，反之，返回新对象 |

### 📐 四步骤图解

```
┌─────────────────────────────────────────────────────────────────┐
│                    new 的四个步骤详解                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   myNew(Person, 'xiaoming', 25)                                │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  Step 1: 解析参数                                        │   │
│   │  ─────────────────────────────────────────────────────   │   │
│   │  Constructor = Person        // 构造函数                 │   │
│   │  args = ['xiaoming', 25]     // 构造函数参数             │   │
│   └─────────────────────────────────────────────────────────┘   │
│                         ↓                                       │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  Step 2: 创建新对象，继承原型                             │   │
│   │  ─────────────────────────────────────────────────────   │   │
│   │  o = Object.create(Person.prototype)                    │   │
│   │                                                         │   │
│   │       o                    Person.prototype             │   │
│   │    ┌──────┐               ┌──────────────┐              │   │
│   │    │      │ __proto__     │ constructor  │              │   │
│   │    │  {}  │ ──────────→   │ 其他方法...   │              │   │
│   │    │      │               │              │              │   │
│   │    └──────┘               └──────────────┘              │   │
│   └─────────────────────────────────────────────────────────┘   │
│                         ↓                                       │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  Step 3: 执行构造函数，绑定 this                          │   │
│   │  ─────────────────────────────────────────────────────   │   │
│   │  res = Person.apply(o, ['xiaoming', 25])                │   │
│   │                                                         │   │
│   │  执行后 o 变成:                                          │   │
│   │    ┌─────────────────────┐                              │   │
│   │    │  name: 'xiaoming'   │                              │   │
│   │    │  age: 25            │                              │   │
│   │    │  __proto__: ...     │                              │   │
│   │    └─────────────────────┘                              │   │
│   └─────────────────────────────────────────────────────────┘   │
│                         ↓                                       │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  Step 4: 判断返回值                                      │   │
│   │  ─────────────────────────────────────────────────────   │   │
│   │  return res instanceof Object ? res : o                 │   │
│   │                                                         │   │
│   │  如果构造函数返回了对象 → 返回那个对象                    │   │
│   │  如果构造函数返回非对象 → 返回新创建的对象 o              │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 手写 new 实现

### 📝 完整代码

```javascript
function myNew(...args) {
    // Step 1: 第一参数作为构造函数，其余参数作为构造函数参数
    const Constructor = args[0]
    
    // Step 2: 继承构造函数原型创建新对象
    const o = Object.create(Constructor.prototype)
    
    // Step 3: 执行构造函数
    const res = Constructor.apply(o, args.slice(1))
    
    // Step 4: 结果为对象，返回结果，反之，返回新对象
    return res instanceof Object ? res : o
}
```

### 📝 使用示例

```javascript
// 定义构造函数
function P(v) {
    this.v = v
}

// 使用 myNew
const p = myNew(P, 1)  // P {v: 1}

console.log(p.v)       // 1
console.log(p instanceof P)  // true
```

---

## 深入理解每个步骤

### 🔍 Step 1：解析参数

```javascript
const Constructor = args[0]      // 取出构造函数
const params = args.slice(1)     // 取出其余参数
```

```
┌─────────────────────────────────────────────────────────────────┐
│   myNew(Person, 'xiaoming', 25)                                │
│          │          │         │                                 │
│          ↓          └────┬────┘                                 │
│    Constructor         params                                   │
│    = Person           = ['xiaoming', 25]                       │
└─────────────────────────────────────────────────────────────────┘
```

### 🔍 Step 2：创建新对象并继承原型

```javascript
const o = Object.create(Constructor.prototype)
```

**为什么用 Object.create？**

```
┌─────────────────────────────────────────────────────────────────┐
│                 Object.create 的作用                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Object.create(proto) 会创建一个新对象，                        │
│   并将新对象的 __proto__ 指向传入的 proto                        │
│                                                                 │
│   等价于：                                                       │
│   ┌────────────────────────────────────────────────────────┐    │
│   │  const o = {}                                          │    │
│   │  o.__proto__ = Constructor.prototype                   │    │
│   └────────────────────────────────────────────────────────┘    │
│                                                                 │
│   这样新对象就能访问构造函数原型上的方法了！                      │
│                                                                 │
│   Person.prototype                                              │
│   ┌──────────────────────┐                                      │
│   │  sayHello: function  │                                      │
│   │  ...                 │                                      │
│   └──────────┬───────────┘                                      │
│              ↑                                                  │
│              │ __proto__                                        │
│   ┌──────────┴───────────┐                                      │
│   │  新创建的对象 o       │                                      │
│   │  (目前还是空的)       │                                      │
│   └──────────────────────┘                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 🔍 Step 3：执行构造函数

```javascript
const res = Constructor.apply(o, args.slice(1))
```

**为什么用 apply？**

```
┌─────────────────────────────────────────────────────────────────┐
│                    apply 的作用                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Constructor.apply(o, args)                                    │
│                  │     │                                        │
│                  │     └── 传递参数数组                          │
│                  │                                              │
│                  └── 将 this 绑定到新对象 o                      │
│                                                                 │
│   执行过程：                                                     │
│   ┌────────────────────────────────────────────────────────┐    │
│   │  function Person(name, age) {                          │    │
│   │      this.name = name;  // this 指向 o                 │    │
│   │      this.age = age;    // 所以属性添加到 o 上          │    │
│   │  }                                                     │    │
│   └────────────────────────────────────────────────────────┘    │
│                                                                 │
│   执行后 o 的状态：                                              │
│   ┌────────────────────────────────────────────────────────┐    │
│   │  o = {                                                 │    │
│   │      name: 'xiaoming',                                 │    │
│   │      age: 25,                                          │    │
│   │      __proto__: Person.prototype                       │    │
│   │  }                                                     │    │
│   └────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 🔍 Step 4：判断返回值

```javascript
return res instanceof Object ? res : o
```

**为什么要判断返回值？**

```
┌─────────────────────────────────────────────────────────────────┐
│                    返回值的特殊情况                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   【情况一】构造函数没有返回值或返回原始值                        │
│   ┌────────────────────────────────────────────────────────┐    │
│   │  function Person(name) {                               │    │
│   │      this.name = name;                                 │    │
│   │      // 没有 return 或 return 123                      │    │
│   │  }                                                     │    │
│   │                                                        │    │
│   │  res = undefined 或 123（原始值）                       │    │
│   │  res instanceof Object → false                         │    │
│   │  返回 o（新创建的对象）✓                                │    │
│   └────────────────────────────────────────────────────────┘    │
│                                                                 │
│   【情况二】构造函数返回一个对象                                 │
│   ┌────────────────────────────────────────────────────────┐    │
│   │  function Person(name) {                               │    │
│   │      this.name = name;                                 │    │
│   │      return { custom: 'object' };  // 返回对象         │    │
│   │  }                                                     │    │
│   │                                                        │    │
│   │  res = { custom: 'object' }                            │    │
│   │  res instanceof Object → true                          │    │
│   │  返回 res（构造函数返回的对象）✓                        │    │
│   └────────────────────────────────────────────────────────┘    │
│                                                                 │
│   这是 JavaScript new 操作符的原生行为！                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 完整流程图

```
┌─────────────────────────────────────────────────────────────────────┐
│                      myNew 完整执行流程                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│                    myNew(Person, 'xiaoming', 25)                   │
│                              │                                      │
│                              ↓                                      │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │ const Constructor = Person                                   │  │
│   │ const args = ['xiaoming', 25]                               │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                              │                                      │
│                              ↓                                      │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │ const o = Object.create(Person.prototype)                   │  │
│   │                                                             │  │
│   │     o = { __proto__: Person.prototype }                     │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                              │                                      │
│                              ↓                                      │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │ const res = Person.apply(o, ['xiaoming', 25])               │  │
│   │                                                             │  │
│   │ 执行 Person，this = o                                       │  │
│   │ o.name = 'xiaoming'                                         │  │
│   │ o.age = 25                                                  │  │
│   │ res = undefined（Person 没有 return）                       │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                              │                                      │
│                              ↓                                      │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │ return res instanceof Object ? res : o                      │  │
│   │                                                             │  │
│   │ undefined instanceof Object → false                         │  │
│   │ 返回 o                                                      │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                              │                                      │
│                              ↓                                      │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │  最终结果：                                                  │  │
│   │  {                                                          │  │
│   │      name: 'xiaoming',                                      │  │
│   │      age: 25,                                               │  │
│   │      __proto__: Person.prototype                            │  │
│   │  }                                                          │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 核心奥义

```
╔═══════════════════════════════════════════════════════════════════════╗
║                                                                       ║
║   🎯 一句话总结：                                                      ║
║                                                                       ║
║   new 的本质就四步：                                                   ║
║   创建空对象，原型链一接，apply 执行构造函数，                          ║
║   返回对象看情况 —— 构造函数返回对象就用它，否则用新创建的！              ║
║                                                                       ║
╚═══════════════════════════════════════════════════════════════════════╝
```

---

## 📋 速记卡片

```
┌─────────────────────────────────────────────────────────────────┐
│                       手写 new 速记                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  【四步口诀】                                                    │
│   1. 取构造函数和参数                                            │
│   2. Object.create 继承原型                                     │
│   3. apply 执行构造函数                                         │
│   4. 判断返回值类型                                              │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  【完整代码】                                                    │
│   function myNew(...args) {                                     │
│       const Constructor = args[0]                               │
│       const o = Object.create(Constructor.prototype)            │
│       const res = Constructor.apply(o, args.slice(1))           │
│       return res instanceof Object ? res : o                    │
│   }                                                             │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  【关键点】                                                      │
│   ✓ Object.create 创建对象并继承原型                            │
│   ✓ apply 绑定 this 并传参                                      │
│   ✓ instanceof Object 判断返回值                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

> 📝 **作者提示**：本文基于 LeetBook 第十四章内容整理，手写 new 是面试高频题，务必理解每一步的作用！